<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Base styles for the main layout */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Make the main content scrollable and flexible */
        .main-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem;
        }
        /* Menu link animations and shadows */
        .menu-link {
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .menu-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
    <script>
        // Tailwind CSS configuration with custom colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼
                        'green-in': '#00a040',
                        'red-out': '#e53935',
                        'yellow-report': '#ffc107',
                        'cyan-view': '#17a2b8',
                        'orange-calc': '#ff9800',
                    }
                }
            }
        }
    </script>
</head>
<body>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ (æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢) - stickyã‚’é©ç”¨ã—ã€å¸¸ã«ä¸Šéƒ¨ã«è¡¨ç¤º -->
    <header id="info-header" class="bg-cyan-view text-white p-4 shadow-2xl flex-shrink-0 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-start space-x-4">
            
            <!-- 1. QRã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ (å·¦å´) -->
            <div id="qr-code-container" class="w-24 h-24 flex-shrink-0 bg-white p-1 rounded-lg shadow-inner flex items-center justify-center border-2 border-cyan-200">
                <img id="qr-code-image" 
                    src="qr.png" 
                    alt="QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã“ã“ã«é…ç½®" 
                    class="object-contain rounded w-full h-full"
                    onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'text-xs text-gray-400 text-center\'>QRç”»åƒ\næœªè¨­å®š</div>'">
            </div>

            <!-- 2. æƒ…å ±ã‚¨ãƒªã‚¢ (å³å´) - è¡¨ç¤ºå†…å®¹ã‚’ã”è¦æœ›ã«åˆã‚ã›ã¦ä¿®æ­£ -->
            <div class="flex-1 flex flex-col justify-between space-y-2 min-w-0 text-right">
                
                <!-- TOP ROW: å ´å†…äººæ•° (æœ€ã‚‚å¤§ããè¡¨ç¤º) -->
                <div id="current-count-display" class="text-lg md:text-5xl font-extrabold flex items-end justify-end">
                    <!-- å ´å†…äººæ•°:0 -->
                    å ´å†…äººæ•°: 
                    <span id="current-count-value" class="ml-2 text-4xl text-yellow-400 tabular-nums">0</span>
                </div>

                <!-- MIDDLE ROW: 100äººã‚ãŸã‚Šå¾…ã¡æ™‚é–“ -->
                <div id="wait-time-display" class="w-full text-base md:text-lg font-light opacity-95">
                    <!-- 100äººå½“ãŸã‚Šå¾…ã¡æ™‚é–“: --åˆ† -->
                    100äººå½“ãŸã‚Šå¾…ã¡æ™‚é–“: 
                    <span id="wait-time-value" class="font-bold tabular-nums">--</span>åˆ†
                </div>
                
                <!-- BOTTOM ROW: å…¥å ´è€…æ•°ã‚µãƒãƒªãƒ¼ (è¨ˆ:ã‚’å«ã‚€è¡¨ç¤º) -->
                <div class="w-full text-base md:text-lg font-light opacity-90 pt-1 border-t border-cyan-400/50">
                    <!-- å…¥å ´è€…æ•°: Day(æ—¥ä»˜)10äºº Day(æ—¥ä»˜)20äºº è¨ˆ:30äºº -->
                    Day1 <span id="event-day1-date">--/--</span>ï¼š<span class="font-bold ml-1 tabular-nums" id="day1-visitors">0</span>äºº 
                    Day2 <span id="event-day2-date">--/--</span>ï¼š<span class="font-bold ml-1 tabular-nums" id="day2-visitors">0</span>äºº 
                    è¨ˆ:<span class="font-bold ml-1 tabular-nums" id="total-visitors">0</span>äºº
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-content flex flex-col justify-start items-center">
        <div class="w-full max-w-xl flex flex-col gap-4 py-6">
            
            <!-- ğŸŸ¢ 1. å…¥å ´ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ (ãƒ•ã‚¡ã‚¤ãƒ«å: counter.html) -->
            <a href="counter.html" 
                id="counter-in-link" 
                class="menu-link bg-green-in hover:bg-green-700 text-white p-8 rounded-2xl text-2xl font-bold flex justify-center items-center h-24">
                ğŸŸ¢ å…¥å ´å£ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            </a>
            
            <!-- ğŸ”´ 2. å‡ºå£ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ (ãƒ•ã‚¡ã‚¤ãƒ«å: counterout.html) -->
            <a href="counterout.html" 
                id="counter-out-link" 
                class="menu-link bg-red-out hover:bg-red-700 text-white p-8 rounded-2xl text-2xl font-bold flex justify-center items-center h-24">
                ğŸ”´ å‡ºå£ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
            </a>
            
            <!-- ğŸ“ 3. ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ² (ãƒ•ã‚¡ã‚¤ãƒ«å: report.html) -->
            <a href="report.html" 
                id="report-link" 
                class="menu-link bg-yellow-report hover:bg-yellow-500 text-gray-800 p-8 rounded-2xl text-2xl font-bold flex justify-center items-center h-24">
                ğŸ“ ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ²
            </a>
            
            <!-- ğŸ•’ 5. å¾…ã¡æ™‚é–“è¨ˆç®— (ãƒ•ã‚¡ã‚¤ãƒ«å: wait.html) -->
            <a href="wait.html" 
                id="calculator-link" 
                class="menu-link bg-orange-calc hover:bg-orange-700 text-white p-8 rounded-2xl text-2xl font-bold flex justify-center items-center h-24">
                ğŸ•’ å¾…ã¡æ™‚é–“è¨ˆç®—
            </a>
                        <!-- ğŸ“ˆ 4. å ´å†…äººæ•°ã‚°ãƒ©ãƒ•ãƒ“ãƒ¥ãƒ¼ (ãƒ•ã‚¡ã‚¤ãƒ«å: view.html)
            <a href="view.html" 
                id="view-link" 
                class="menu-link bg-cyan-view hover:bg-cyan-700 text-white p-8 rounded-2xl text-2xl font-bold flex justify-center items-center h-24">
                ğŸ“ˆ ã‚°ãƒ©ãƒ•
            </a> -->
            
        </div>
    </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, doc, onSnapshot, collection, query, where 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ==================== åŸºæœ¬è¨­å®š ====================
const firebaseConfig = {
  apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
  authDomain: "setapanmarketcounter.firebaseapp.com",
  projectId: "setapanmarketcounter",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let dayMap = {}; // { day1: "2025-11-01", day2: "2025-11-02" }
let logData = [];

const el = {
  current: document.getElementById("current-count-value"),
  wait: document.getElementById("wait-time-value"),
  day1: document.getElementById("day1-visitors"),
  day2: document.getElementById("day2-visitors"),
  total: document.getElementById("total-visitors"),
  date1: document.getElementById("event-day1-date"),
  date2: document.getElementById("event-day2-date"),
};

// ==================== æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•° ====================
const toYMD = (ts) => {
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toISOString().split("T")[0]; // "YYYY-MM-DD"
};
const toMD = (ts) => {
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleDateString("ja-JP", { month: "2-digit", day: "2-digit", timeZone: "Asia/Tokyo" });
};

// ==================== æ—¥ä»˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç›£è¦– ====================
onSnapshot(doc(db, "artifacts/setapanmarketcounter/public/data/static/day"), (snap) => {
  if (!snap.exists()) return console.warn("âš ï¸ dayãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“");

  const data = snap.data();
  dayMap.day1 = toYMD(data.day1);
  dayMap.day2 = toYMD(data.day2);

  el.date1.textContent = toMD(data.day1);
  el.date2.textContent = toMD(data.day2);

  setupLogListener(); // æ—¥ä»˜å–å¾—å¾Œã«å®Ÿè¡Œ
});

// ==================== ãƒ­ã‚°ç›£è¦– ====================
function setupLogListener() {
  onSnapshot(collection(db, "artifacts/setapanmarketcounter/public/data/log"), (snap) => {
    logData = snap.docs.map(d => d.data());
    updateDisplay();
  });
}

// ==================== è¡¨ç¤ºæ›´æ–° ====================
function updateDisplay() {
  if (!dayMap.day1 || !dayMap.day2) return;

  const now = new Date();
  let counts = { in: 0, out: 0, exitin: 0 };
  let totals = { [dayMap.day1]: 0, [dayMap.day2]: 0 };
  let recentIn = 0;

  const lookbackMs = 10 * 60 * 1000;
  const since = new Date(now.getTime() - lookbackMs);

  logData.forEach(l => {
    const ts = l.timestamp?.toDate ? l.timestamp.toDate() : null;
    if (!ts) return;
    const day = l.event_day; // "2025-11-01"ãªã©
    if (!totals.hasOwnProperty(day)) return;

    const c = l.count ?? 1;
    if (l.type === "in" || l.type === "exitin") {
      counts.in += c;
      if (l.type === "exitin") counts.exitin += c;
      totals[day] += c;
      if (ts >= since) recentIn += c;
    } else if (l.type === "out") {
      counts.out += c;
    }
  });

  // ğŸ§® ç¾åœ¨ã®å ´å†…äººæ•°
  const current = Math.max(0, counts.in - counts.out);
  el.current.textContent = current.toLocaleString();

  // ğŸ‘¥ å†…è¨³ï¼ˆå‡ºå£å…¥å ´ï¼‰
  document.getElementById("exitin-count")?.remove();
  const exitinEl = document.createElement("span");
  exitinEl.id = "exitin-count";
  exitinEl.textContent = `ï¼ˆå†…ã€å‡ºå£${counts.exitin}ï¼‰`;
  exitinEl.className = "ml-2 text-base text-gray-300";
  el.current.insertAdjacentElement("afterend", exitinEl);

  // ğŸ“Š å„æ—¥ã¨åˆè¨ˆ
  el.day1.textContent = totals[dayMap.day1].toLocaleString();
  el.day2.textContent = totals[dayMap.day2].toLocaleString();
  el.total.textContent = (totals[dayMap.day1] + totals[dayMap.day2]).toLocaleString();

  // â± å¾…ã¡æ™‚é–“
  el.wait.textContent = recentIn > 0 ? ((10 / recentIn) * 100).toFixed(1) : "--";
}

// ==================== åŒ¿åèªè¨¼ ====================
signInAnonymously(auth).then(() => console.log("âœ… åŒ¿åèªè¨¼å®Œäº†"));
</script>
</body>
</html>
