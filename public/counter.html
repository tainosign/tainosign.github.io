<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入場カウンター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem;
        }
        .menu-link {
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .menu-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'green-in': '#00a040',
                        'red-out': '#e53935',
                        'yellow-claim': '#ffc107',
                        'cyan-view': '#17a2b8',
                        'orange-calc': '#ff9800',
                    }
                }
            }
        }
    </script>
</head>
<body>

    <!-- ✅ index.htmlと完全一致のヘッダー -->
    <header id="info-header" class="bg-cyan-view text-white p-4 shadow-2xl flex-shrink-0 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-start space-x-4">
            <div id="qr-code-container" class="w-24 h-24 flex-shrink-0 bg-white p-1 rounded-lg shadow-inner flex items-center justify-center border-2 border-cyan-200">
                <img id="qr-code-image" src="qr.png" alt="QRコード画像をここに配置" 
                     class="w-full h-full object-contain rounded"
                     onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'text-xs text-gray-400 text-center\'>QR画像\n未設定</div>'">
            </div>

            <div class="flex-1 flex flex-col justify-between space-y-2 min-w-0">
                <div class="flex flex-col items-end text-sm">
                    <div id="current-date-time" class="font-medium whitespace-nowrap opacity-90">現在日時: --/-- --:--:--</div>
                    <div id="event-date-summary" class="font-light whitespace-nowrap opacity-80 mt-0.5">
                        <span id="target-date">イベント日: </span>
                        Day1(<span id="event-day1-date">未設定</span>) / Day2(<span id="event-day2-date">未設定</span>)
                    </div>
                </div>
                <div id="current-count-display" class="text-4xl md:text-5xl font-extrabold flex items-center justify-end">
                    場内人数: 
                    <span id="current-count-value" class="ml-2 text-yellow-400 tabular-nums">0</span>
                </div>
                <div class="w-full text-right text-xs md:text-sm space-y-0.5 opacity-90 pt-2 border-t border-cyan-400/50">
                    <div id="wait-time-display" class="font-light">
                        100人当たり待ち時間: <span id="wait-time-value" class="font-bold">--</span>分
                    </div>
                    <div class="total-visitors font-light">
                        総入場者数: Day1<span class="font-bold ml-1 tabular-nums" id="day1-visitors">0</span>人 Day2<span class="font-bold ml-1 tabular-nums" id="day2-visitors">0</span>人
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 以下は counter.html 固有のコンテンツ -->
    <main class="main-content">
        <div class="max-w-md mx-auto mt-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">入場カウンター</h1>
            <div class="flex justify-center gap-6">
                <button id="add-in-btn" class="bg-green-in text-white px-8 py-4 rounded-2xl text-xl font-bold shadow-md hover:bg-green-700 transition">＋ 入場</button>
                <button id="remove-in-btn" class="bg-gray-400 text-white px-8 py-4 rounded-2xl text-xl font-bold shadow-md hover:bg-gray-600 transition">－ 修正</button>
            </div>
        </div>
    </main>

    <!-- ✅ Firebase共通ヘッダーと同一ロジック -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase設定（index.htmlと共通）
        const firebaseConfig = {
            apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
            authDomain: "setapanmarketcounter.firebaseapp.com",
            projectId: "setapanmarketcounter",
            storageBucket: "setapanmarketcounter.firebasestorage.app",
            messagingSenderId: "546423839721",
            appId: "1:546423839721:web:70d5c12129fe6cc1594978"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const currentDateEl = document.getElementById('current-date-time');
        const eventDay1DateEl = document.getElementById('event-day1-date');
        const eventDay2DateEl = document.getElementById('event-day2-date');
        const currentCountValueEl = document.getElementById('current-count-value');
        const day1VisitorsEl = document.getElementById('day1-visitors');
        const day2VisitorsEl = document.getElementById('day2-visitors');
        const waitTimeValueEl = document.getElementById('wait-time-value');

        // 共通のリアルタイム時計
        function updateCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit', timeZone: 'Asia/Tokyo' });
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Tokyo' });
            currentDateEl.textContent = `現在日時: ${dateStr} ${timeStr}`;
        }
        setInterval(updateCurrentDateTime, 1000);
        updateCurrentDateTime();

        // Firestore購読（index.htmlと同じ）
        const getPublicCollectionPath = (collectionName) => `/artifacts/setapanmarketcounter/public/data/${collectionName}`;
        const getDayDocRef = (db) => doc(db, getPublicCollectionPath('static'), 'day');
        const getLogCollectionRef = (db) => collection(db, getPublicCollectionPath('log'));

        async function initFirebase() {
            setLogLevel('Debug');
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => {
                if (!user) return;

                // 日付設定
                onSnapshot(getDayDocRef(db), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        eventDay1DateEl.textContent = new Date(data.day1.seconds * 1000).toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
                        eventDay2DateEl.textContent = new Date(data.day2.seconds * 1000).toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
                    }
                });

                // ログ監視
                onSnapshot(getLogCollectionRef(db), (snapshot) => {
                    let count = 0, day1 = 0, day2 = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.type === 'in') {
                            count += data.count || 1;
                            if (data.event_day === 'day1') day1 += data.count || 1;
                            if (data.event_day === 'day2') day2 += data.count || 1;
                        } else if (data.type === 'out') {
                            count -= data.count || 1;
                        }
                    });
                    currentCountValueEl.textContent = Math.max(0, count).toLocaleString();
                    day1VisitorsEl.textContent = day1.toLocaleString();
                    day2VisitorsEl.textContent = day2.toLocaleString();
                    waitTimeValueEl.textContent = Math.floor(count / 50) * 5;
                });
            });
        }
        initFirebase();

        // 入場ボタン処理
        document.getElementById('add-in-btn').addEventListener('click', async () => {
            await addDoc(getLogCollectionRef(db), {
                type: 'in',
                count: 1,
                event_day: 'day1',
                timestamp: new Date()
            });
        });
    </script>
</body>
</html>
