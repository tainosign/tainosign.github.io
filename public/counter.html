<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¥å ´ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Base styles for the main layout from index.html */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ç”¨ */
        .counter-button {
            transition: transform 0.1s ease-in-out, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .counter-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .large-counter-button {
            height: 40vh; /* ç”»é¢é«˜ã•ã®40%ã‚’ä½¿ç”¨ */
            min-height: 200px;
        }
        .small-counter-button {
            height: 25vh; /* ç”»é¢é«˜ã•ã®25%ã‚’ä½¿ç”¨ */
            min-height: 120px;
        }
    </style>
    <script>
        // Tailwind CSS configuration with custom colors (index.htmlã‹ã‚‰ç¶™æ‰¿)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼
                        'green-in': '#00a040',
                        'red-out': '#e53935',
                        'yellow-claim': '#ffc107',
                        'cyan-view': '#17a2b8',
                        'orange-calc': '#ff9800',
                    }
                }
            }
        }
    </script>
</head>
<body>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ (index.htmlã‹ã‚‰å®Œå…¨ã«ç¶™æ‰¿) -->
    <header id="info-header" class="bg-cyan-view text-white p-4 shadow-2xl flex-shrink-0 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-start space-x-4">
            
            <!-- 1. QRã‚³ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ (å·¦å´) -->
            <div id="qr-code-container" class="w-24 h-24 flex-shrink-0 bg-white p-1 rounded-lg shadow-inner flex items-center justify-center border-2 border-cyan-200">
                <img id="qr-code-image" 
                    src="qrin.png" 
                    alt="QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã“ã“ã«é…ç½®" 
                    class="w-full h-full object-contain rounded"
                    onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'text-xs text-gray-400 text-center\'>QRç”»åƒ\næœªè¨­å®š</div>'">
            </div>

            <!-- 2. æƒ…å ±ã‚¨ãƒªã‚¢ (å³å´) -->
            <div class="flex-1 flex flex-col justify-between space-y-2 min-w-0">
                
                <!-- TOP ROW: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ—¥æ™‚ & ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ï¼‰-->
                <div class="flex flex-col items-end text-sm">
                    <div id="current-date-time" class="font-medium whitespace-nowrap opacity-90">ç¾åœ¨æ—¥æ™‚: --/-- --:--:--</div>
                    <div id="event-date-summary" class="font-light whitespace-nowrap opacity-80 mt-0.5">
                        <span id="target-date">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥: </span>
                        Day1(<span id="event-day1-date">æœªè¨­å®š</span>) / Day2(<span id="event-day2-date">æœªè¨­å®š</span>)
                    </div>
                </div>

                <!-- MIDDLE ROW: å ´å†…äººæ•° (æœ€ã‚‚å¤§ããè¡¨ç¤º) -->
                <div id="current-count-display" class="text-lg md:text-lg font-extrabold flex items-center justify-end">
                    å ´å†…äººæ•°: 
                    <span id="current-count-value" class="ml-2 text-4xl text-yellow-400 tabular-nums">0</span>
                </div>

                <!-- BOTTOM ROW: æ¥å ´è€…æ•°ã‚µãƒãƒªãƒ¼ã¨å¾…ã¡æ™‚é–“ -->
                <div class="w-full text-right text-xs md:text-sm space-y-0.5 opacity-90 pt-2 border-t border-cyan-400/50">
                    <div id="wait-time-display" class="font-light">
                        100äººå½“ãŸã‚Šå¾…ã¡æ™‚é–“: <span id="wait-time-value" class="font-bold">--</span>åˆ†
                    </div>
                    <div class="total-visitors font-light">
                        Day1<span class="font-bold ml-1 tabular-nums" id="day1-visitors">0</span>äºº Day2<span class="font-bold ml-1 tabular-nums" id="day2-visitors">0</span>äºº
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ (ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ - ç”»åƒéƒ¨åˆ†) -->
    <div class="main-content flex flex-col justify-start items-center">
        <div class="w-full max-w-xl flex flex-col gap-4 py-6">
            
            <!-- ğŸŸ¢ +1 ãƒœã‚¿ãƒ³ (ç”»åƒã§æœ€ã‚‚å¤§ããã€ç·‘è‰²ã®éƒ¨åˆ†ã‚’å†ç¾) -->
            <button onclick="logCount('in', 1)" 
                    class="counter-button large-counter-button w-full bg-green-in text-white rounded-2xl hover:bg-green-700 p-8 flex items-center justify-center font-extrabold text-[8rem] leading-none">
                +1
            </button>

            <!-- +5 / +10 ãƒœã‚¿ãƒ³ (ç”»åƒä¸‹éƒ¨ã®ç°è‰²ã®ãƒœã‚¿ãƒ³ã‚’å†ç¾) -->
            <div class="flex space-x-4 h-auto">
                <button onclick="logCount('in', 5)"
                        class="counter-button small-counter-button flex-1 bg-gray-500 text-white rounded-2xl hover:bg-gray-600 p-6 flex items-center justify-center font-extrabold text-7xl">
                    +5
                </button>
                <button onclick="logCount('in', 10)"
                        class="counter-button small-counter-button flex-1 bg-gray-500 text-white rounded-2xl hover:bg-gray-600 p-6 flex items-center justify-center font-extrabold text-7xl">
                    +10
                </button>
            </div>
            
            <!-- è£œè¶³ï¼šç”»åƒã«ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¸›ç®—ã®ãƒ‹ãƒ¼ã‚ºã‚’è€ƒæ…®ã—ã¦ -1 ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã‚¨ãƒªã‚¢ (çœç•¥) -->
            
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ (ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹) - index.htmlã®ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚°ã¨çµ±ä¸€ -->
    <footer class="p-4 bg-gray-200 text-gray-700 flex-shrink-0 border-t border-gray-300">
        <a href="index.html" class="block w-full text-center bg-gray-400 hover:bg-gray-500 active:bg-gray-600 transition-colors py-3 rounded-lg shadow-md font-semibold text-lg text-white">
            ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹
        </a>
    </footer>

    <!-- Firebase SDK (ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯) - index.htmlã‹ã‚‰ç¶™æ‰¿ã—ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ  -->
    <script type="module">
        // Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------
        // 1. Firebaseè¨­å®šã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (index.htmlã‹ã‚‰ç¶™æ‰¿)
        // ----------------------------------------------------
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
            }
        }

        // ç’°å¢ƒå¤‰æ•°ãŒåˆ©ç”¨ã§ããªã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
                authDomain: "setapanmarketcounter.firebaseapp.com",
                databaseURL: "https://setapanmarketcounter-default-rtdb.firebaseio.com",
                projectId: "setapanmarketcounter",
                storageBucket: "setapanmarketcounter.firebasestorage.app",
                messagingSenderId: "546423839721",
                appId: "1:546423839721:web:70d5c12129fe6cc1594978",
                measurementId: "G-70KHJ0P1P1"
            };
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'setapanmarketcounter'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let daySettings = { day1: null, day2: null }; // æ—¥ä»˜è¨­å®šã‚’ä¿æŒ

        // UIè¦ç´ 
        const currentCountValueEl = document.getElementById('current-count-value');
        const waitTimeValueEl = document.getElementById('wait-time-value');
        const day1VisitorsEl = document.getElementById('day1-visitors');
        const day2VisitorsEl = document.getElementById('day2-visitors');
        const eventDay1DateEl = document.getElementById('event-day1-date');
        const eventDay2DateEl = document.getElementById('event-day2-date');
        const currentDateEl = document.getElementById('current-date-time');
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹å®šç¾©ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const getPublicCollectionPath = (collectionName) => 
            `/artifacts/${appId}/public/data/${collectionName}`;

        const getDayDocRef = (dbInstance) => 
            doc(dbInstance, getPublicCollectionPath('static'), 'day'); 

        const getLogCollectionRef = (dbInstance) => 
            collection(dbInstance, getPublicCollectionPath('log')); 

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ (MM/DDå½¢å¼)
        const formatDate = (timestamp) => {
            if (!timestamp) return 'æœªè¨­å®š';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit', timeZone: 'Asia/Tokyo' });
        };

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¾åœ¨æ—¥æ™‚ã‚’æ›´æ–°ã™ã‚‹é–¢æ•° (ç§’å˜ä½ã¾ã§è¡¨ç¤º)
        function updateCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { 
                month: '2-digit', 
                day: '2-digit', 
                timeZone: 'Asia/Tokyo' 
            });
            const timeStr = now.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false, 
                timeZone: 'Asia/Tokyo' 
            });
            currentDateEl.textContent = `ç¾åœ¨æ—¥æ™‚: ${dateStr} ${timeStr}`;
        }
        
        // ----------------------------------------------------
        // 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒŠãƒ¼ (index.htmlã‹ã‚‰ç¶™æ‰¿)
        // ----------------------------------------------------
        function setupRealtimeListener() {
            if (!db) {
                console.error("Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
                return;
            }

            // --- A. æ—¥ä»˜è¨­å®šã®ç›£è¦– (static/day) ---
            onSnapshot(getDayDocRef(db), (docSnap) => {
                if (docSnap.exists()) {
                    daySettings = docSnap.data();
                    eventDay1DateEl.textContent = formatDate(daySettings.day1);
                    eventDay2DateEl.textContent = formatDate(daySettings.day2);
                } else {
                    console.warn("æ—¥ä»˜è¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                }
            }, (error) => {
                console.error("æ—¥ä»˜è¨­å®šã®è³¼èª­ã‚¨ãƒ©ãƒ¼:", error);
            });

            // --- B. ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã¨é›†è¨ˆ (logã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³) ---
// --- B. ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®ç›£è¦–ã¨é›†è¨ˆ (logã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³) ---
onSnapshot(getLogCollectionRef(db), (snapshot) => {
    let currentCount = 0;
    let day1TotalIn = 0;
    let day2TotalIn = 0;
    let exitinCount = 0; // ğŸ‘ˆ è¿½åŠ : å‡ºå£ã‹ã‚‰å…¥å ´ã—ãŸäººæ•°

    const now = new Date();
    const todayStr = now.toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });
    const lookbackMinutes = 10;
    const lookbackMs = lookbackMinutes * 60 * 1000;
    const sinceTime = new Date(now.getTime() - lookbackMs);
    let recentInCount = 0;

    snapshot.forEach(doc => {
        const data = doc.data();
        const type = data.type;
        const eventDay = data.event_day;
        const count = typeof data.count === 'number' && data.count > 0 ? data.count : 1;
        const ts = data.timestamp?.toDate ? data.timestamp.toDate() : null;
        if (!ts) return;

        const tsDateStr = ts.toLocaleDateString('ja-JP', { timeZone: 'Asia/Tokyo' });
        if (tsDateStr !== todayStr) return;

        if (type === 'in') {
            currentCount += count;
            if (eventDay === 'day1') day1TotalIn += count;
            else if (eventDay === 'day2') day2TotalIn += count;
            if (ts >= sinceTime) recentInCount += count;
        } 
        else if (type === 'exitin') {
            currentCount += count;      // é€šå¸¸å…¥å ´ã¨åŒæ§˜ã«ã‚«ã‚¦ãƒ³ãƒˆ
            exitinCount += count;       // ğŸ‘ˆ å†…è¨³ç”¨ã‚«ã‚¦ãƒ³ã‚¿ã‚’åŠ ç®—
            if (eventDay === 'day1') day1TotalIn += count;
            else if (eventDay === 'day2') day2TotalIn += count;
            if (ts >= sinceTime) recentInCount += count;
        } 
        else if (type === 'out') {
            currentCount -= count;
        }
    });

    currentCount = Math.max(0, currentCount);

    // ğŸ”¹è¡¨ç¤ºæ›´æ–°ï¼ˆexitinå†…è¨³ä»˜ãï¼‰
    currentCountValueEl.innerHTML = `${currentCount.toLocaleString()} <span class="text-sm text-gray-200">(å†…ã€å‡ºå£${exitinCount.toLocaleString()})</span>`;

    day1VisitorsEl.textContent = day1TotalIn.toLocaleString();
    day2VisitorsEl.textContent = day2TotalIn.toLocaleString();

    let waitTimeText = '--';
    if (recentInCount > 0) {
        const timePer100 = 3000 / recentInCount;
        waitTimeText = timePer100.toFixed(1);
    }
    waitTimeValueEl.textContent = waitTimeText;

}, (error) => {
    console.error(`ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ç›£è¦–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    currentCountValueEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼';
    waitTimeValueEl.textContent = '--';
});
        }

        // ----------------------------------------------------
        // 3. ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ©Ÿèƒ½ (äººæ•°ã‚’ãƒ­ã‚°ã«è¨˜éŒ²)
        // ----------------------------------------------------
        window.logCount = async (type, count) => {
            if (!db || !userId) {
                console.error("Database not initialized or user not authenticated.");
                return;
            }

            // ç¾åœ¨ã®æ—¥ä»˜ã«åŸºã¥ã„ã¦ event_day ('day1' or 'day2') ã‚’æ±ºå®š
            let eventDay = 'unknown';
            const now = new Date();
            
            // daySettingsã«Timestampã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Œã°toMillis()ã‚’ä½¿ç”¨
            const day1Timestamp = daySettings.day1 ? daySettings.day1.toMillis() : null;
            const day2Timestamp = daySettings.day2 ? daySettings.day2.toMillis() : null;

            if (day1Timestamp && now.getTime() >= day1Timestamp && (!day2Timestamp || now.getTime() < day2Timestamp)) {
                eventDay = 'day1';
            } else if (day2Timestamp && now.getTime() >= day2Timestamp) {
                eventDay = 'day2';
            }
            
            const logEntry = {
                type: type, // 'in' or 'out'
                count: count,
                event_day: eventDay,
                timestamp: serverTimestamp(),
                user_id: userId,
                // GPSæƒ…å ±ãªã©ã‚‚ã‚ã‚Œã°è¿½åŠ å¯èƒ½
            };

            try {
                // logã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                await addDoc(getLogCollectionRef(db), logEntry);
                console.log(`Log added: ${type} x ${count} on ${eventDay}`);
                // æˆåŠŸæ™‚ã®è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (ä¾‹: ãƒœã‚¿ãƒ³ã‚’çŸ­æ™‚é–“ã§ç‚¹æ»…ã•ã›ã‚‹ãªã©)
                flashButton(event); 
            } catch (e) {
                console.error("Error writing log document:", e);
                // å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’å®Ÿè£…
            }
        };

        // ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (ä¾‹: æˆåŠŸæ™‚)
        function flashButton(event) {
            const button = event.target.closest('button');
            if (button) {
                const originalBg = button.style.backgroundColor || button.className.match(/bg-[\w-]+/)[0];
                button.classList.add('animate-pulse');
                setTimeout(() => {
                    button.classList.remove('animate-pulse');
                }, 300);
            }
        }
        
        // ----------------------------------------------------
        // 4. åˆæœŸåŒ–å‡¦ç† (index.htmlã‹ã‚‰ç¶™æ‰¿)
        // ----------------------------------------------------
        async function initializeAppAndAuth() {
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000); // 1ç§’ã”ã¨ã«æ™‚åˆ»ã‚’æ›´æ–°

            if (!firebaseConfig) {
                currentCountValueEl.textContent = 'è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼';
                console.error("è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šãŒãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }

            setLogLevel('Debug');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setupRealtimeListener();
                    } else {
                        console.log("åŒ¿åèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                        currentCountValueEl.textContent = 'èªè¨¼å¤±æ•—';
                    }
                });
                
            } catch (e) {
                console.error(`FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                currentCountValueEl.textContent = 'åˆæœŸåŒ–å¤±æ•—';
            }
        }

        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>










