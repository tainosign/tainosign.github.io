<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>å…¥å ´å´ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ğŸ’¡ ç”»é¢å…¨ä½“ã«å…¥å ´ãƒœã‚¿ãƒ³ã‚’æœ€å¤§åŒ– */
        body { 
            font-family: 'Inter', sans-serif; 
            text-align: center; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f4f4; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            touch-action: pan-y; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
        }

        /* --- ğŸ’¡ ãƒ˜ãƒƒãƒ€ãƒ¼é ˜åŸŸã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .header-container {
            background-color: #17a2b8; /* cyan-view */
            color: white;
            padding: 3vw 5vw; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* QRã‚³ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ */
        .qr-code-area {
            flex-shrink: 0; 
            margin-right: 4vw; 
            width: 30vw; 
            height: auto;
            display: flex; 
            align-items: center;
            justify-content: center;
            max-width: 150px; 
        }

        /* QRã‚³ãƒ¼ãƒ‰ç”»åƒ */
        #qr-image {
            width: 100% !important; 
            height: auto !important; 
            border-radius: 5px;
            background-color: white; 
            padding: 5px;
            object-fit: contain; 
        }

        /* æƒ…å ±ã‚¨ãƒªã‚¢å…¨ä½“ */
        .info-area {
            text-align: right; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
        }

        /* å¯¾è±¡æ—¥ */
        #target-date {
            font-size: 4.5vw; 
            margin-bottom: 0.2vw; 
            line-height: 1.2;
            white-space: nowrap; 
        }

        /* ç¾åœ¨å ´å†…äººæ•° */
        #current-count-display { 
            font-size: 5vw; 
            font-weight: bold;
            white-space: nowrap; 
            margin-bottom: 0.5vw;
        }

        #current-count-value { 
            font-weight: bold; 
            font-size: 12vw; 
            color: #FFC107; /* é»„è‰²ã§ç›®ç«‹ãŸã›ã‚‹ */
            line-height: 1;
        }

        #wait-time-display, .total-visitors {
            font-size: 3.5vw; 
            line-height: 1.2;
        }
        #wait-time-display{
            margin-top: -1vw; 
            margin-bottom: 0.1vw; 
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼‰ --- */
        #main-content { 
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 4vw 5vw 2vw; 
            width: 100%; 
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        /* +1 ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        #in-btn {
            width: 100%; 
            font-size: 25vw;
            font-weight: bold;
            color: white; 
            border: none; 
            border-radius: 3vw 3vw 0 0; 
            background-color: #4CAF50; /* ç·‘ */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3); 
            cursor: pointer; 
            transition: background-color 0.1s, transform 0.1s;
            touch-action: manipulation;
            margin-bottom: 3px; 
            flex-grow: 1; 
        }
        #in-btn:active { background-color: #3e8e41; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); transform: translateY(3px); }

        /* è¤‡æ•°ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .multi-count-group {
            display: flex;
            width: 100%;
            flex-shrink: 0;
            height: 15vh;
        }

        /* è¤‡æ•°ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .multi-count-btn {
            flex-grow: 1;
            padding: 0; 
            font-size: 10vw; 
            font-weight: bold;
            color: white;
            border: none;
            background-color: #6c757d; 
            cursor: pointer;
            transition: background-color 0.1s, transform 0.1s;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2); 
            touch-action: manipulation;
            line-height: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .multi-count-btn:active { background-color: #495057; transform: translateY(2px); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }

        /* +5 ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #in-btn-5 {
            border-radius: 0 0 0 3vw; 
            margin-right: 3px; 
        }

        /* +10 ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #in-btn-10 {
            border-radius: 0 0 3vw 0; 
        }

        #status { 
            flex-shrink: 0; 
            margin-top: 2vw; 
            font-size: 4vw; 
            color: #666; 
            min-height: 5vw; 
        }

        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-button-container {
            flex-shrink: 0;
            width: 90vw;
            margin: 0 auto 5vw;
        }
        .back-button {
            display: block; 
            padding: 3vw 5vw; 
            background-color: #6c757d; 
            color: white; 
            border: none; 
            border-radius: 2vw; 
            text-decoration: none;
            font-size: 4vw;
            transition: background-color 0.1s;
        }
        .back-button:active {
            background-color: #495057;
        }

        .updating {
            transition: all 0.2s ease-in-out;
            color: #FFC107 !important; 
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ----------------------------------------------------
        // 1. Firebaseè¨­å®šã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° 
        // ----------------------------------------------------
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—ã—ã€ãªã„å ´åˆã¯ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // â˜…â˜…â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èªè¨¼æƒ…å ±ã®é©ç”¨ â˜…â˜…â˜…
        if (Object.keys(firebaseConfig).length === 0) {
            console.warn("ç’°å¢ƒå¤‰æ•°__firebase_configãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            firebaseConfig = {
                apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
                authDomain: "setapanmarketcounter.firebaseapp.com",
                databaseURL: "https://setapanmarketcounter-default-rtdb.firebaseio.com",
                projectId: "setapanmarketcounter",
                storageBucket: "setapanmarketcounter.firebasestorage.app",
                messagingSenderId: "546423839721",
                appId: "1:546423839721:web:70d5c12129fe6cc1594978",
                measurementId: "G-70KHJ0P1P1"
            };
        }

        // æä¾›ã•ã‚ŒãŸãƒ­ã‚°æƒ…å ±ã‹ã‚‰ã‚¢ãƒ—ãƒªIDã‚’å–å¾—ã—ã€Firebase ConfigãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç¢ºä¿
        // projectIdã¾ãŸã¯appIdã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || firebaseConfig.appId || 'setapanmarketcounter';

        // Firestore ãƒ‘ã‚¹å®šç¾© 
        // /artifacts/{appId}/public/data/log/...
        const LOG_COLLECTION_PATH = `artifacts/${appId}/public/data/log`;
        // /artifacts/{appId}/public/data/summary/counts
        const summaryDocRef = (db) => doc(db, `artifacts/${appId}/public/data/summary`, 'counts');
        // /artifacts/{appId}/public/data/static/day (æ—¥ä»˜è¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
        const dateConfigDocRef = (db) => doc(db, `artifacts/${appId}/public/data/static`, 'day');

        let db, auth, userId;
        let isProcessing = false;
        let currentEventDay = 'day1'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆæ—¥ä»˜è¨­å®šãŒå–å¾—ã§ããªã„å ´åˆï¼‰
        
        // UIè¦ç´  (ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å–å¾—)
        const currentCountValueEl = document.getElementById('current-count-value');
        const waitTimeValueEl = document.getElementById('wait-time-value');
        const totalVisitorsEl = document.querySelector('.total-visitors');
        const targetDateEl = document.getElementById('target-date');
        const statusElement = document.getElementById('status');


        // ----------------------------------------------------
        // 2. ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
        // ----------------------------------------------------
        function setupRealtimeListener(db) {
            
            // --- A. æ—¥ä»˜è¨­å®šã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– ---
            onSnapshot(dateConfigDocRef(db), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    // day1, day2ãŒã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šã—ã€æ—¥ä»˜æ–‡å­—åˆ—ã«å¤‰æ›
                    const day1Timestamp = data.day1; 
                    const day2Timestamp = data.day2;
                    currentEventDay = data.current_day || 'day1'; // è¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«current_dayãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèª

                    let day1DateStr = '---';
                    let day2DateStr = '---';
                    
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®æ—¥ä»˜æ–‡å­—åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    if (day1Timestamp && day1Timestamp.toDate) {
                        day1DateStr = day1Timestamp.toDate().toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
                    }
                    if (day2Timestamp && day2Timestamp.toDate) {
                        day2DateStr = day2Timestamp.toDate().toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
                    }

                    // ãƒ˜ãƒƒãƒ€ãƒ¼UIã®æ›´æ–°
                    const displayDate = currentEventDay === 'day1' ? day1DateStr : day2DateStr;
                    targetDateEl.textContent = `å¯¾è±¡æ—¥: ${currentEventDay} (${displayDate})`;
                    targetDateEl.classList.remove('text-red-500'); 
                    
                } else {
                    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆ
                    targetDateEl.textContent = `å¯¾è±¡æ—¥: ãƒ‡ãƒ¼ã‚¿ãªã— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ ${currentEventDay})`;
                    targetDateEl.classList.add('text-red-500');
                    console.warn("æ—¥ä»˜è¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                }
            }, (error) => {
                // æ—¥ä»˜è¨­å®šã®è³¼èª­ã‚¨ãƒ©ãƒ¼
                targetDateEl.textContent = `å¯¾è±¡æ—¥: å–å¾—å¤±æ•— ğŸš¨`;
                targetDateEl.classList.add('text-red-500');
                console.error("æ—¥ä»˜è¨­å®šã®è³¼èª­ã‚¨ãƒ©ãƒ¼:", error);
            });


            // --- B. é›†è¨ˆã‚µãƒãƒªãƒ¼ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– ---
            onSnapshot(summaryDocRef(db), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const currentCount = data.current_count || 0;
                    
                    // 1. å ´å†…äººæ•°
                    currentCountValueEl.textContent = currentCount.toLocaleString();

                    // 2. æ¥å ´è€…æ•°
                    const day1 = data.day1_total_visitors || 0; 
                    const day2 = data.day2_total_visitors || 0;
                    
                    totalVisitorsEl.textContent = `1æ—¥ç›®: ${day1.toLocaleString()}äºº 2æ—¥ç›®: ${day2.toLocaleString()}äºº`;

                    // 3. å¾…ã¡æ™‚é–“
                    let waitTime = Math.max(0, Math.floor(currentCount / 50) * 5); // 50äººã”ã¨ã«5åˆ†è¿½åŠ 
                    waitTimeValueEl.textContent = `${waitTime}åˆ†`;
                } else {
                    currentCountValueEl.textContent = '0';
                    totalVisitorsEl.textContent = '1æ—¥ç›®: 0äºº 2æ—¥ç›®: 0äºº';
                    waitTimeValueEl.textContent = '--åˆ†';
                }
            }, (error) => {
                // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã®è³¼èª­ã‚¨ãƒ©ãƒ¼
                if (error.message.includes("permission")) {
                    statusElement.textContent = 'ğŸš¨ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    console.error("Firestore Permission Error:", error);
                } else {
                    statusElement.textContent = `ğŸš¨ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message.substring(0, 50)}...`;
                    console.error("Data Listener Error:", error);
                }
                currentCountValueEl.textContent = 'å–å¾—å¤±æ•—';
            });
        }

        // ----------------------------------------------------
        // 3. ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ©Ÿèƒ½ (ãƒ­ã‚°æ›¸ãè¾¼ã¿)
        // ----------------------------------------------------
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function displayError(message) {
            console.error(message);
            statusElement.textContent = `ğŸš¨ ã‚¨ãƒ©ãƒ¼: ${message.substring(0, 50)}...`;
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è§£é™¤
            currentCountValueEl.classList.remove('updating');
            isProcessing = false;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®æ“ä½œé–¢æ•°
        window.handleButtonClick = async function(count = 1) {
            if (isProcessing) {
                statusElement.textContent = 'å‡¦ç†ä¸­ã§ã™...';
                return;
            }
            
            // ğŸš¨ èªè¨¼ãŒå¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã€å‡¦ç†ã‚’ä¸­æ–­
            if (!userId) {
                statusElement.textContent = 'ğŸš¨ èªè¨¼ãŒæœªå®Œäº†ã®ãŸã‚ã€è¨˜éŒ²ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            isProcessing = true;
            const countButtons = document.querySelectorAll('#in-btn, .multi-count-btn');

            // 1. UIã®æ›´æ–°ï¼ˆæš«å®šå€¤ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            countButtons.forEach(btn => btn.disabled = true);
            statusElement.textContent = `å…¥å ´ (+${count}äºº) ã‚’è¨˜éŒ²ä¸­...`;

            // æš«å®šçš„ãªå ´å†…äººæ•°è¡¨ç¤ºæ›´æ–°
            const currentCountText = currentCountValueEl.textContent;
            const currentCount = parseInt(currentCountText.replace(/[,\u3000-]/g, ''), 10) || 0;
            const newCount = Math.max(0, currentCount + count); 
            
            currentCountValueEl.textContent = newCount.toLocaleString();
            currentCountValueEl.classList.add('updating'); 

            try {
                // ãƒ­ã‚°ã®æ›¸ãè¾¼ã¿
                const logData = {
                    type: 'in', // å…¥å ´å°‚ç”¨
                    count: count, 
                    timestamp: serverTimestamp(), // Firestoreå´ã§æ­£ç¢ºãªæ™‚åˆ»ã‚’è¨˜éŒ²
                    recorded_by_uid: userId,
                    event_day: currentEventDay, // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å–å¾—ã—ãŸæ—¥ä»˜è¨­å®šã‚’åæ˜ 
                };
                
                // ãƒ­ã‚°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
                await addDoc(collection(db, LOG_COLLECTION_PATH), logData);

                statusElement.textContent = `âœ… å…¥å ´ (+${count}äºº) è¨˜éŒ²å®Œäº†ï¼`;

            } catch (error) {
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€å…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
                if (error.message.includes("permission")) {
                    displayError('è¨˜éŒ²å¤±æ•—: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šæ›¸ãè¾¼ã¿ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚');
                } else {
                    displayError(`ãƒ­ã‚°ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–ã—ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è§£é™¤
                setTimeout(() => {
                    countButtons.forEach(btn => btn.disabled = false);
                    isProcessing = false;
                    currentCountValueEl.classList.remove('updating');
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ãŒæœ€çµ‚çš„ãªå€¤ã‚’æ›´æ–°ã™ã‚‹ã®ã‚’å¾…ã¤
                }, 500);
            }
        }

        // ----------------------------------------------------
        // 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        // ----------------------------------------------------
        async function initializeAppAndAuth() {
            // UIã®åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            statusElement.textContent = 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...';

            try {
                // Configã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã‚Šå¿…ãšå­˜åœ¨ã™ã‚‹ãŸã‚ã€ã“ã“ã§Configã®æœ‰ç„¡ãƒã‚§ãƒƒã‚¯ã¯è¡Œã‚ãªã„
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // èªè¨¼æˆåŠŸæ™‚
                if (auth.currentUser) {
                    userId = auth.currentUser.uid;
                    // å®Œå…¨ãªUIDã¯é•·ã„ãŸã‚ã€æœ€åˆã®8æ–‡å­—ã®ã¿è¡¨ç¤ºï¼ˆç®¡ç†è€…ã®ã¿ãŒå®Œå…¨ãªIDã‚’ä½¿ç”¨ï¼‰
                    statusElement.textContent = `æ¥ç¶šæˆåŠŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId.substring(0, 8)}...`;
                    
                    // èªè¨¼å¾Œã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
                    setupRealtimeListener(db);
                } else {
                    throw new Error("User authentication failed and currentUser is null.");
                }
                
            } catch (e) {
                let errorMessage = `FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                displayError(errorMessage);
                userId = null; 
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹å§‹
        window.onload = initializeAppAndAuth;
    </script>

    <header class="header-container">
        <div class="qr-code-area">
            <!-- QRã‚³ãƒ¼ãƒ‰ã®ãƒ¢ãƒƒã‚¯: Firebaseã§ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œãªã„ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨ -->
            <img id="qr-image" 
                         src='https://placehold.co/150x150/FFFFFF/AAAAAA?text=QR+Code' 
                         alt="QR Code" 
                         onerror="this.src='https://placehold.co/150x150/FFFFFF/AAAAAA?text=QR+Code'" 
            > 
        </div>

        <div class="info-area">
            <!-- å¯¾è±¡æ—¥ã®åˆæœŸå€¤ã¯ã€JSã§ä¸Šæ›¸ãã•ã‚Œã‚‹ã¾ã§ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã™ã‚‹ -->
            <div id="target-date">å¯¾è±¡æ—¥: ---</div> 
            <div id="current-count-display">å ´å†…äººæ•°: <span id="current-count-value">0</span></div>
            <div id="wait-time-display">100äººå½“ãŸã‚Šå¾…ã¡æ™‚é–“: <span id="wait-time-value">--åˆ†</span></div>
            <div class="total-visitors">
                1æ—¥ç›®: 0äºº 2æ—¥ç›®: 0äºº
            </div>
        </div>
    </header>

    <div id="main-content">
        <!-- handleButtonClick(count) ã®å¼•æ•°ã¯ã‚«ã‚¦ãƒ³ãƒˆæ•°ã®ã¿ã«å¤‰æ›´ -->
        <button id="in-btn" class="count-button" onclick="handleButtonClick(1)">+1</button>
        
        <div class="multi-count-group">
            <button id="in-btn-5" class="multi-count-btn" onclick="handleButtonClick(5)">+5</button>
            <button id="in-btn-10" class="multi-count-btn" onclick="handleButtonClick(10)">+10</button>
        </div>
        
        <div id="status">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
    </div>

    <div class="back-button-container">
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã¯ã€index.htmlã¸é·ç§»ã™ã‚‹ã‚ˆã†ã«å›ºå®š -->
        <a href="./index.html" class="back-button">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</a>
    </div>
</body>
</html>
