<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>入場カウンター</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { touch-action: manipulation; -ms-touch-action: manipulation; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    button, .counter-button {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .main-content { overflow-y: auto; flex-grow: 1; padding: 1rem; }
    .counter-button {
      transition: transform 0.1s ease-in-out, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .counter-button:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .large-counter-button { height: 38vh; min-height: 200px; }
    .small-counter-button { height: 27vh; min-height: 120px; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'green-in': '#00a040',
            'red-out': '#e53935',
            'yellow-claim': '#ffc107',
            'cyan-view': '#17a2b8',
            'orange-calc': '#ff9800',
          }
        }
      }
    }
  </script>
</head>

<body>
  <!-- ✅ ヘッダー（index.htmlと完全共通） -->
  <header id="info-header" class="bg-cyan-view text-white flex-shrink-0 z-10">
    <div class="max-w-4xl mx-auto flex justify-between items-start space-x-4">
      <div id="qr-code-container" class="w-24 h-24 flex-shrink-0 bg-white p-1 rounded-lg shadow-inner flex items-center justify-center border-2 border-cyan-200">
        <img id="qr-code-image" src="qrin.png" alt="QRコード画像" class="w-full h-full object-contain rounded"
          onerror="this.style.display='none'; this.parentNode.innerHTML='<div class=\'text-xs text-gray-400 text-center\'>QR未設定</div>'">
      </div>
      <div class="flex-1 flex flex-col justify-between space-y-2 min-w-0">
        <div class="flex flex-col items-end text-sm">
          <div id="current-date-time" class="font-medium whitespace-nowrap opacity-90">現在日時: --/-- --:--:--</div>
          <div id="event-date-summary" class="font-light whitespace-nowrap opacity-80 mt-0.5">
            イベント日: <span id="event-day1-date">未設定</span> / <span id="event-day2-date">未設定</span>
          </div>
        </div>
        <div id="current-count-display" class="text-lg md:text-lg font-extrabold flex items-center justify-end">
          場内人数:
          <span id="current-count-value" class="ml-2 text-4xl text-yellow-400 tabular-nums">0</span>
        </div>
        <div class="w-full text-right text-xs md:text-sm space-y-0.5 opacity-90 pt-2 border-t border-cyan-400/50">
          <div id="wait-time-display">100人当たり待ち時間: <span id="wait-time-value" class="font-bold">--</span>分</div>
          <div class="total-visitors">
            <span id="day1-visitors">0</span>人 / <span id="day2-visitors">0</span>人
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ✅ カウンター本体 -->
  <div class="main-content flex flex-col justify-start items-center">
    <div class="w-full max-w-xl flex flex-col gap-4 py-2">
      <button onclick="logCount('in', 1)" class="counter-button large-counter-button w-full bg-green-in text-white rounded-2xl hover:bg-green-700 p-8 flex items-center justify-center font-extrabold text-[8rem]">
        +1
      </button>
      <div class="flex space-x-4">
        <button onclick="logCount('in', 5)" class="counter-button small-counter-button flex-1 bg-gray-500 text-white rounded-2xl hover:bg-gray-600 p-6 flex items-center justify-center font-extrabold text-7xl">+5</button>
        <button onclick="logCount('in', 10)" class="counter-button small-counter-button flex-1 bg-gray-500 text-white rounded-2xl hover:bg-gray-600 p-6 flex items-center justify-center font-extrabold text-7xl">+10</button>
      </div>
    </div>
  </div>

  <footer class="p-4 bg-gray-200 text-gray-700 border-t border-gray-300">
    <a href="index.html" class="block text-center bg-gray-400 hover:bg-gray-500 active:bg-gray-600 py-3 rounded-lg shadow-md font-semibold text-lg text-white">メニューへ戻る</a>
  </footer>

  <!-- ✅ Firebase外部化版 ロジック -->
  <script type="module">
    import { initializeFirebase } from "/js/firebase-config.js";
    import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const { db } = await initializeFirebase();
    const appId = "setapanmarketcounter";
    let userId = null;
    let dayMap = {}; // { day1: "2025-11-01", day2: "2025-11-02" }

    // 要素取得
    const el = {
      current: document.getElementById("current-count-value"),
      wait: document.getElementById("wait-time-value"),
      day1: document.getElementById("day1-visitors"),
      day2: document.getElementById("day2-visitors"),
      date1: document.getElementById("event-day1-date"),
      date2: document.getElementById("event-day2-date"),
      currentDate: document.getElementById("current-date-time")
    };

    // 日付変換
    const toYMD = (ts) => {
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toISOString().split("T")[0];
    };
    const toMD = (ts) => {
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleDateString("ja-JP", { month: "2-digit", day: "2-digit", timeZone: "Asia/Tokyo" });
    };

    // 日付情報取得
    onSnapshot(doc(db, `artifacts/${appId}/public/data/static/day`), (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();
      dayMap.day1 = toYMD(data.day1);
      dayMap.day2 = toYMD(data.day2);
      el.date1.textContent = toMD(data.day1);
      el.date2.textContent = toMD(data.day2);
    });

    // 時計
    function updateClock() {
      const now = new Date();
      el.currentDate.textContent = `現在日時: ${now.toLocaleDateString("ja-JP", {month:"2-digit", day:"2-digit"})} ${now.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ✅ カウント登録関数
    window.logCount = async (type, count) => {
      const now = new Date();
      const today = now.toISOString().split("T")[0];
      const event_day = (today === dayMap.day1) ? dayMap.day1 : (today === dayMap.day2 ? dayMap.day2 : today);

      const logEntry = {
        type, count,
        event_day,
        timestamp: serverTimestamp(),
      };

      await addDoc(collection(db, `artifacts/${appId}/public/data/log`), logEntry);
      console.log(`Logged ${type} x${count} (${event_day})`);
    };
  </script>
</body>
</html>
