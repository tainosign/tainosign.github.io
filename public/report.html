<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ </title>
    <!-- Tailwind CSS CDNã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        // Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        let db, auth;
        let userId = null;
        let vendorSelect; // <select id="place"> è¦ç´ ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
            }
        }

        // ç’°å¢ƒå¤‰æ•°ãŒåˆ©ç”¨ã§ããªã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
                authDomain: "setapanmarketcounter.firebaseapp.com",
                databaseURL: "https://setapanmarketcounter-default-rtdb.firebaseio.com",
                projectId: "setapanmarketcounter",
                storageBucket: "setapanmarketcounter.firebasestorage.app",
                messagingSenderId: "546423839721",
                appId: "1:546423839721:web:70d5c12129fe6cc1594978",
                measurementId: "G-70KHJ0P1P1"
            };
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'setapanmarketcounter'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestoreã®ãƒ‘ã‚¹ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getLogCollectionRef(dbInstance) {
            return collection(dbInstance, `/artifacts/${appId}/public/data/log`);
        }

        function updateCurrentDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const timestampInput = document.getElementById('timestamp');
            if (timestampInput) {
                timestampInput.value = now.toISOString().slice(0, 16);
            }
        }

        async function initializeAppAndAuth() {
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000); // 1ç§’ã”ã¨ã«æ™‚åˆ»ã‚’æ›´æ–°

            if (!firebaseConfig) {
                currentCountValueEl.textContent = 'è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼';
                console.error("è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: Firebaseè¨­å®šãŒãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }

            setLogLevel('Debug');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setupRealtimeListener();
                    } else {
                        console.log("åŒ¿åèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                        currentCountValueEl.textContent = 'èªè¨¼å¤±æ•—';
                    }
                });
                
            } catch (e) {
                console.error(`FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                currentCountValueEl.textContent = 'åˆæœŸåŒ–å¤±æ•—';
            }
        }

        const VENDOR_LIST = {
    'day1': [
        //ãã®ä»–
        'ã”å½“åœ°ãƒ‘ãƒ³',
        'äºˆç´„ãƒ‘ãƒ³å—ã‘å–ã‚Š',
        'ãƒ‘ãƒ³ã®å›³æ›¸é¤¨',
        'HWVåºƒå ´',
        'HWVæ ¡é–€å‰é§è¼ªå ´',
        'HWVåºƒå ´æ¨ªé§è¼ªå ´',
        'ãƒ‘ãƒ³ãƒãƒ¼ã‚±ãƒƒãƒˆå¾…æ©Ÿåˆ—',
        'ã‚³ãƒ³ãƒ†ã‚¹ãƒˆæŠ•ç¥¨æ‰€',
        'ä¸–ç”°è°·ãƒ‘ãƒ³ãƒ©ã‚¸ã‚ª',
        'ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³',
        'ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
        'ä¼‘æ†©ã‚¹ãƒšãƒ¼ã‚¹(ã•ãã‚‰)',
        'ä¼‘æ†©ã‚¹ãƒšãƒ¼ã‚¹(ã‹ãˆã§)',
        'ç‰¹è¨­ã‚¹ãƒ†ãƒ¼ã‚¸',
        'ã„ã¡ã‚‡ã†ãƒˆã‚¤ãƒ¬',
        'ã•ãã‚‰ãƒˆã‚¤ãƒ¬',
        'SL',
        'å¹³å’Œè³‡æ–™é¤¨',
        'å…¬åœ’ç®¡ç†äº‹å‹™æ‰€',
        'ãƒã‚¤ã‚¯é§è¼ªæ‰€',
        'ã„ã¡ã‚‡ã†ãƒˆã‚¤ãƒ¬æ¨ªé§è¼ªå ´',
        'æ´‹å¼“å ´æ¨ªé§è¼ªå ´'
    ],
    'day2': [
        //ãã®ä»–
        'ã”å½“åœ°ãƒ‘ãƒ³',
        'äºˆç´„ãƒ‘ãƒ³å—ã‘å–ã‚Š',
        'ãƒ‘ãƒ³ã®å›³æ›¸é¤¨',
        'HWVåºƒå ´',
        'HWVæ ¡é–€å‰é§è¼ªå ´',
        'HWVåºƒå ´æ¨ªé§è¼ªå ´',
        'ãƒ‘ãƒ³ãƒãƒ¼ã‚±ãƒƒãƒˆå¾…æ©Ÿåˆ—',
        'ã‚³ãƒ³ãƒ†ã‚¹ãƒˆæŠ•ç¥¨æ‰€',
        'ä¸–ç”°è°·ãƒ‘ãƒ³ãƒ©ã‚¸ã‚ª',
        'ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³',
        'ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
        'ä¼‘æ†©ã‚¹ãƒšãƒ¼ã‚¹(ã•ãã‚‰)',
        'ä¼‘æ†©ã‚¹ãƒšãƒ¼ã‚¹(ã‹ãˆã§)',
        'ç‰¹è¨­ã‚¹ãƒ†ãƒ¼ã‚¸',
        'ã„ã¡ã‚‡ã†ãƒˆã‚¤ãƒ¬',
        'ã•ãã‚‰ãƒˆã‚¤ãƒ¬',
        'SL',
        'å¹³å’Œè³‡æ–™é¤¨',
        'å…¬åœ’ç®¡ç†äº‹å‹™æ‰€',
        'ãƒã‚¤ã‚¯é§è¼ªæ‰€',
        'ã„ã¡ã‚‡ã†ãƒˆã‚¤ãƒ¬æ¨ªé§è¼ªå ´',
        'æ´‹å¼“å ´æ¨ªé§è¼ªå ´'
    ]
};
        

        function generateVendorOptionsGrouped(dayStr) {
            const list = VENDOR_LIST[`day${dayStr}`] || [];
            let html = '';
            
            const groups = {
                'ãƒ‘ãƒ³ãƒ»ãƒãƒ¼ã‚±ãƒƒãƒˆ': [],
                'ãƒ‘ãƒ³ã®ãŠã¨ã‚‚': [],
                'ã‚°ãƒƒã‚º/ãƒ•ãƒ¼ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ–': [],
                'ãƒ‰ãƒªãƒ³ã‚¯ï¼†ãƒ•ãƒ¼ãƒ‰': [],
                'HWVã¨ãƒ‘ãƒ³å¤§å­¦': [],
                'å”è³›': [],
                'ãã®ä»–': []
            };
            
            list.forEach(fullName => {
                const match = fullName.match(/^(\d+)\./);
                const num = match ? parseInt(match[1]) : null;
                
                let category = 'ãã®ä»–';
                
                // GASã®åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  if (num >= 1 && num <= 56) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category = 'ãƒ‘ãƒ³ãƒ»ãƒãƒ¼ã‚±ãƒƒãƒˆ';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (num >= 60 && num <= 79) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category = 'ãƒ‘ãƒ³ã®ãŠã¨ã‚‚';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (num >= 80 && num <= 81) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category = 'ã‚°ãƒƒã‚º/ãƒ•ãƒ¼ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ–';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (num >= 83 && num <= 108) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category = 'ãƒ‰ãƒªãƒ³ã‚¯ï¼†ãƒ•ãƒ¼ãƒ‰';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (num >= 110 && num <= 121) { // HWVã¨ãƒ‘ãƒ³å¤§å­¦ã®ç¯„å›²ã‚’æ˜ç¢ºã«å®šç¾© (122ã‚’é™¤ã)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category = 'HWVã¨ãƒ‘ãƒ³å¤§å­¦';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // å€‹åˆ¥ç•ªå·ã¨ã€Œå”è³›ã€ã‚’å«ã‚€ã‚‚ã®ã‚’ãƒã‚§ãƒƒã‚¯ (HWVã¨ãƒ‘ãƒ³å¤§å­¦ã¨é‡è¤‡ã™ã‚‹ç•ªå·ã‚’å‰Šé™¤)
Â  Â  Â  Â  Â  Â  Â  Â  else if ([57, 58, 59, 82, 122].includes(num) || fullName.includes('å”è³›')) { // 109, 110, 111ã‚’å‰Šé™¤ã—ã€122ã‚’è¿½åŠ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category = 'å”è³›';
Â  Â  Â  Â  Â  Â  Â  Â  }
                
                // å­˜åœ¨ã—ãªã„ã‚«ãƒ†ã‚´ãƒªã¸ã®è¿½åŠ ã‚’é˜²ã
                if (groups[category]) {
                    groups[category].push(fullName);
                } else {
                    groups['ãã®ä»–'].push(fullName);
                }
            });
            
            // HTMLã®ç”Ÿæˆ
            for (const [label, items] of Object.entries(groups)) {
                if (items.length > 0) {
                    html += `<optgroup label="--- ${label} ---">`;
                    items.forEach(fullName => {
                        // ç´”ç²‹ãªåº—èˆ—åã‚’å–å¾— (valueå±æ€§ç”¨)
                        let pureName = fullName
                            .replace(/^\d+\.\s*/, '')
                            .replace(/\s\(ä¸¡æ—¥\)$/, '')
                            .replace(/ by æ—¥æœ¬ãƒ‘ãƒ³ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼å”ä¼š/, '')
                            .trim();
                            
                        // fullNameã¯ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
                        html += `<option value="${pureName}">${fullName}</option>`;
                    });
                    html += `</optgroup>`;
                }
            }

            return html;
        }

        async function recordReport(formData) {
            if (!db) {
                console.error("FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                throw new Error("FirestoreãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
            }

            // å ±å‘Šç¨®åˆ¥ã«åŸºã¥ã„ã¦place/contentã‚’æ±ºå®š
            let placeText = formData.place; 
            let contentText = formData.content;

            // å ±å‘Šãƒ­ã‚°ã®å½¢å¼ã‚’å®šç¾©
            const reportData = {
                // å ±å‘Šãƒ­ã‚°ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™å›ºå®šã®type
                type: formData.report_type, 
                
                // å ´å†…äººæ•°é›†è¨ˆã§èª¤ã£ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„ã‚ˆã†ã«countã¯çœç•¥ (ã‚‚ã—å¿…è¦ãªã‚‰0ã‚’è¨­å®š)
                count: 0, 

                // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®å ±å‘Šã¯ã™ã¹ã¦åŒã˜event_dayã«ç´ã¥ã‘ã‚‹ (day1/day2)
                event_day: `day${formData.event_day_selector}`, 
                
                // ç™ºç”Ÿæ™‚åˆ» (æ‰‹å‹•å…¥åŠ›ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°ã‚µãƒ¼ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—)
                timestamp: formData.timestamp ? new Date(formData.timestamp) : serverTimestamp(), 

                // æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                content: contentText,     // å ±å‘Šå†…å®¹ï¼ˆtextareaï¼‰
                place: placeText,         // ç™ºç”Ÿå ´æ‰€/å¯¾è±¡ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å€¤ï¼‰
                reporter: formData.reporter.trim() || 'åŒ¿å', // å ±å‘Šè€…åï¼ˆtext inputï¼‰
                vendor_name: formData.place || '', // å‡ºåº—è€…å (select)

                // èªè¨¼æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
                user_id: userId,
            };

            // GASã®ãƒ­ã‚¸ãƒƒã‚¯ã«è¿‘ããªã‚‹ã‚ˆã†ã« typeï¼ˆå ±å‘Šç¨®åˆ¥ï¼‰ã‚’ content ã«è¿½åŠ 
            // ä¾‹: content: "[å‡ºåº—è€…] - å†…å®¹..." ã®ã‚ˆã†ã«æ•´å½¢ã™ã‚‹
            reportData.content = `[${formData.report_type}] ${reportData.content}`;


            // ãƒ‡ãƒ¼ã‚¿è¿½åŠ å‡¦ç†
            const docRef = await addDoc(getLogCollectionRef(db), reportData);
            
            console.log("å ±å‘Šãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚Document ID:", docRef.id);
            return {
                status: `å ±å‘Šã€Œ${formData.report_type}ã€ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`,
                type: formData.report_type
            };
        }

        function updateVendorList() {
            // vendorSelect ãŒã¾ã  DOM ã«å­˜åœ¨ã—ãªã„ã‹ã€å‚ç…§ã§ãã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
            if (!vendorSelect) return; 

            const selectedDayEl = document.querySelector('input[name="event_day_selector"]:checked');
            const selectedTypeEl = document.querySelector('input[name="report_type"]:checked');
            const statusEl = document.getElementById('status'); // statusè¦ç´ ã‚’å†åº¦å–å¾—

            if (!selectedDayEl) {
                vendorSelect.innerHTML = '<option value="">- å¯¾è±¡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ -</option>';
                vendorSelect.disabled = true;
                return;
            }
            
            const selectedDay = selectedDayEl.value;
            const selectedType = selectedTypeEl ? selectedTypeEl.value : null;

            if (!selectedType) {
                vendorSelect.innerHTML = '<option value="">- å ±å‘Šç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ -</option>';
                vendorSelect.disabled = true;
                return;
            }
            
            vendorSelect.disabled = true;
            if (statusEl) statusEl.innerText = `ãƒªã‚¹ãƒˆ (Day ${selectedDay} / ${selectedType}) ã‚’èª­ã¿è¾¼ã¿ä¸­...`;
            
            try {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§HTMLã‚’ç”Ÿæˆ
                // ğŸ’¡ ä¿®æ­£ 4: generateVendorOptionsGrouped ã« selectedDay ã®ã¿æ¸¡ã™
                const optionsHtml = generateVendorOptionsGrouped(selectedDay); 
                
                // ğŸ’¡ ä¿®æ­£: åˆæœŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å‹•çš„ã«å¤‰æ›´
                const initialOptionText = (selectedType === 'å‡ºåº—è€…') 
                    ? '- å‡ºåº—è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ (ä»»æ„) -' 
                    : '- å ´æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„ (ä»»æ„) -';
                    
                vendorSelect.innerHTML = `<option value="">${initialOptionText}</option>` + optionsHtml;
                vendorSelect.disabled = false;
                if (statusEl) statusEl.innerText = 'ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†ã€‚';

            } catch(error) {
                if (statusEl) statusEl.innerText = 'ã‚¨ãƒ©ãƒ¼: ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                console.error("å‡ºåº—è€…ãƒªã‚¹ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                vendorSelect.disabled = false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            
            // ğŸ’¡ ä¿®æ­£ 2: FirebaseåˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã€çµæœã‚’å¾…ã¤
            const isFirebaseReady = await initializeAppAndAuth(); 
            if (!isFirebaseReady) {
                document.getElementById('status').innerText = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
            }

            const form = document.getElementById('reportForm');
            const statusEl = document.getElementById('status');
            const recordBtn = document.getElementById('record-btn');
            
            // ğŸ’¡ ä¿®æ­£ 1: vendorSelect ã®å®šç¾©ã‚’ DOMContentLoaded ã®ä¸­ã§å®Ÿè¡Œã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—å¤‰æ•°ã«æ ¼ç´
            const daySelectors = document.querySelectorAll('input[name="event_day_selector"]');
            const reportTypeSelectors = document.querySelectorAll('input[name="report_type"]'); // å ±å‘Šç¨®åˆ¥ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
            vendorSelect = document.getElementById('place'); // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã® vendorSelect ã«ä»£å…¥

            // 1. åˆæœŸæ™‚åˆ»è¨­å®š (initializeAppAndAuth å†…ã«ç§»å‹•)

            // 2. åˆæœŸã‚¤ãƒ™ãƒ³ãƒˆæ—¥è¨­å®š
            const initialEventDay = '1'; 
            // ğŸ’¡ ä¿®æ­£ 6: å ±å‘Šç¨®åˆ¥ã‚‚åˆæœŸé¸æŠã™ã‚‹ã€‚ã“ã‚ŒãŒãªã„ã¨ã€updateVendorList ã® selectedTypeEl ãŒ null ã«ãªã‚‹ã€‚
            document.getElementById('daySelector' + initialEventDay).checked = true;
            document.getElementById('vendor').checked = true; // ä¾‹ã¨ã—ã¦ã€Œå‡ºåº—è€…ã€ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
            
            // 3. ãƒªã‚¹ãƒˆã®åˆæœŸãƒ­ãƒ¼ãƒ‰ (vendorSelect ãŒå®šç¾©ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œ)
            updateVendorList();

            // 4. å¯¾è±¡æ—¥ãŠã‚ˆã³å ±å‘Šç¨®åˆ¥é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            
            // å¯¾è±¡æ—¥ (1æ—¥ç›®/2æ—¥ç›®) é¸æŠæ™‚
            daySelectors.forEach(radio => {
                radio.addEventListener('change', updateVendorList);
            });
            
            // å ±å‘Šç¨®åˆ¥ (å‡ºåº—è€…/æ¥å ´è€…/ãã®ä»–) é¸æŠæ™‚
            reportTypeSelectors.forEach(radio => {
                radio.addEventListener('change', updateVendorList);
            });
            
            // 5. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const typeEl = document.querySelector('input[name="report_type"]:checked');
                const dayEl = document.querySelector('input[name="event_day_selector"]:checked');
                
                if (!typeEl || !dayEl) {
                    showMessage('ã‚¨ãƒ©ãƒ¼: å ±å‘Šç¨®åˆ¥ã¨å¯¾è±¡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                    return;
                }

                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                const formData = {
                    report_type: typeEl.value,
                    event_day_selector: dayEl.value,
                    content: document.getElementById('content').value.trim(), 
                    // ğŸ’¡ ä¿®æ­£: vendorSelect (selectè¦ç´ ) ã®å€¤ã‚’å–å¾—
                    place: vendorSelect.value, 
                    reporter: document.getElementById('reporter').value.trim(), 
                    timestamp: document.getElementById('timestamp').value 
                };

                if (!formData.content) {
                    showMessage('ã‚¨ãƒ©ãƒ¼: å†…å®¹ã¯å¿…é ˆã§ã™ã€‚', 'error');
                    return;
                }
                
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                recordBtn.disabled = true;
                showMessage('é€ä¿¡ä¸­...', 'info');

                try {
                    const result = await recordReport(formData);
                    showMessage(`âœ… ${result.status}`, 'success');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æ™‚åˆ»ã¨ãƒªã‚¹ãƒˆã‚’å†è¨­å®š
                    form.reset();
                    
                    // ğŸ’¡ ä¿®æ­£ 3: æ™‚åˆ»ã¨åˆæœŸé¸æŠã‚’å†è¨­å®š
                    updateCurrentDateTime();
                    document.getElementById('daySelector' + initialEventDay).checked = true;
                    document.getElementById('vendor').checked = true;
                    updateVendorList(); 
                    
                } catch (error) {
                    console.error("Firestoreã¸ã®è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:", error);
                    showMessage('è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                } finally {
                    recordBtn.disabled = false;
                }
            });

            /** ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° */
            function showMessage(message, type) {
                statusEl.innerText = message;
                statusEl.className = 'mt-3 text-center text-sm font-semibold p-2 rounded-lg';
                if (type === 'success') {
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                } else {
                    statusEl.classList.add('bg-blue-100', 'text-blue-800');
                }
            }
        });

    </script>
</head>
<body class="bg-gray-100 min-h-screen pt-4 pb-16 font-sans">

    <div class="max-w-xl mx-auto px-4">
        <h1 class="text-3xl font-extrabold text-red-600 text-center mb-6 pb-2 rounded-lg">
            ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
        </h1>
        
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <form id="reportForm">
                
                <!-- å ±å‘Šç¨®åˆ¥ -->
                <div class="mb-6">
                    <label class="block text-xl font-bold text-gray-700 mb-3">å ±å‘Šç¨®åˆ¥ (å¿…é ˆ):</label>
                    <div class="flex flex-wrap justify-between gap-3">
                        <label class="flex items-center text-lg cursor-pointer bg-red-50 hover:bg-red-100 p-3 rounded-xl flex-grow justify-center sm:flex-grow-0 transition duration-150 ease-in-out">
                            <input type="radio" id="vendor" name="report_type" value="å‡ºåº—è€…" class="form-radio h-5 w-5 text-red-600 mr-2" required>
                            <span class="font-medium">å‡ºåº—è€…</span>
                        </label>
                        <label class="flex items-center text-lg cursor-pointer bg-red-50 hover:bg-red-100 p-3 rounded-xl flex-grow justify-center sm:flex-grow-0 transition duration-150 ease-in-out">
                            <input type="radio" id="visitor" name="report_type" value="æ¥å ´è€…" class="form-radio h-5 w-5 text-red-600 mr-2">
                            <span class="font-medium">æ¥å ´è€…</span>
                        </label>
                        <label class="flex items-center text-lg cursor-pointer bg-red-50 hover:bg-red-100 p-3 rounded-xl flex-grow justify-center sm:flex-grow-0 transition duration-150 ease-in-out">
                            <input type="radio" id="other" name="report_type" value="ãã®ä»–" class="form-radio h-5 w-5 text-red-600 mr-2">
                            <span class="font-medium">ãã®ä»–</span>
                        </label>
                    </div>
                </div>
                
                <!-- å¯¾è±¡æ—¥ -->
                <div class="mb-6">
                    <label class="block text-xl font-bold text-gray-700 mb-3">å¯¾è±¡æ—¥ (å¿…é ˆ):</label>
                    <div class="flex gap-10">
                        <label class="flex items-center text-lg cursor-pointer">
                            <input type="radio" id="daySelector1" name="event_day_selector" value="1" class="form-radio h-5 w-5 text-red-600 mr-2" required>
                            <span class="font-medium">1æ—¥ç›®</span>
                        </label>
                        <label class="flex items-center text-lg cursor-pointer">
                            <input type="radio" id="daySelector2" name="event_day_selector" value="2" class="form-radio h-5 w-5 text-red-600 mr-2">
                            <span class="font-medium">2æ—¥ç›®</span>
                        </label>
                    </div>
                </div>
                
                <!-- å ´æ‰€(ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³) -->
                <div class="mb-6">
                    <label for="place" class="block text-xl font-bold text-gray-700 mb-2">å‡ºåº—è€…ã‚„å ´æ‰€(ãªã‘ã‚Œã°å†…å®¹ã«è¨˜è¼‰):</label> 
                    <select id="place" name="place" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base">
                        <option value="">- é¸æŠã—ã¦ãã ã•ã„ (ä»»æ„) -</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- å ±å‘Šè€…å -->
                <div class="mb-6">
                    <label for="reporter" class="block text-xl font-bold text-gray-700 mb-2">å ±å‘Šè€…å (ä»»æ„):</label>
                    <input type="text" id="reporter" name="reporter" required placeholder="ä¾‹: æ‹…å½“è€…åã€ã‚¹ã‚¿ãƒƒãƒ•A" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base">
                </div>

                <!-- å†…å®¹ -->
                <div class="mb-6">
                    <label for="content" class="block text-xl font-bold text-gray-700 mb-2">å†…å®¹ (å¿…é ˆ):</label>
                    <textarea id="content" name="content" required placeholder="å…·ä½“çš„ãªçŠ¶æ³ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base resize-y"></textarea>
                </div>
                
                <!-- ç™ºç”Ÿæ™‚åˆ» -->
                <div class="mb-8">
                    <label for="timestamp" class="block text-xl font-bold text-gray-700 mb-2">ç™ºç”Ÿæ™‚åˆ» (ä»»æ„):</label>
                    <input type="datetime-local" id="timestamp" name="timestamp" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base">
                </div>
                
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div id="status" class="mt-3 text-center text-sm font-semibold p-2 rounded-lg min-h-8"></div>
                
                <!-- è¨˜éŒ²ãƒœã‚¿ãƒ³ -->
                <button type="submit" id="record-btn" class="w-full py-4 bg-red-600 text-white text-2xl font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-300 transform active:scale-95">
                    è¨˜éŒ²ã™ã‚‹
                </button>
            </form>
        </div>

        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ (å›ºå®šãƒ‘ã‚¹/index.htmlã«æˆ»ã‚‹ã“ã¨ã‚’æƒ³å®š) -->
        <a href="index.html" class="block w-full py-3 mt-6 text-center text-lg font-semibold text-gray-600 bg-white border border-gray-300 rounded-xl shadow hover:bg-gray-100 transition duration-200">
            ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹
        </a>
    </div>

</body>
</html>
