<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トラブル等記録フォーム</title>
    <!-- Tailwind CSS CDNの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKの読み込み -->
    <script type="module">
        // Firebase SDKのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        let db, auth;
        let userId = null;
        let vendorSelect; // <select id="place"> 要素を格納する変数
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
            }
        }

        // 環境変数が利用できない場合、ユーザーから提供された設定を使用
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
                authDomain: "setapanmarketcounter.firebaseapp.com",
                databaseURL: "https://setapanmarketcounter-default-rtdb.firebaseio.com",
                projectId: "setapanmarketcounter",
                storageBucket: "setapanmarketcounter.firebasestorage.app",
                messagingSenderId: "546423839721",
                appId: "1:546423839721:web:70d5c12129fe6cc1594978",
                measurementId: "G-70KHJ0P1P1"
            };
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'setapanmarketcounter'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestoreのパス生成ヘルパー関数
        function getLogCollectionRef(dbInstance) {
            return collection(dbInstance, `/artifacts/${appId}/public/data/log`);
        }

        function updateCurrentDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const timestampInput = document.getElementById('timestamp');
            if (timestampInput) {
                timestampInput.value = now.toISOString().slice(0, 16);
            }
        }

        async function initializeAppAndAuth() {
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000); // 1秒ごとに時刻を更新

            if (!firebaseConfig) {
                currentCountValueEl.textContent = '致命的エラー';
                console.error("致命的エラー: Firebase設定がロードできませんでした。");
                return;
            }

            setLogLevel('Debug');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setupRealtimeListener();
                    } else {
                        console.log("匿名認証に失敗しました。");
                        currentCountValueEl.textContent = '認証失敗';
                    }
                });
                
            } catch (e) {
                console.error(`Firebase初期化または認証エラー: ${e.message}`);
                currentCountValueEl.textContent = '初期化失敗';
            }
        }

        const VENDOR_LIST = {
    'day1': [
        //'1. ',
        '2. COBOTO BAKERY SHOP',
        //'3. ',
        '4. hnn',
        //'5. ',
        '6. キャラバン', 
        //'7. ',
        '8. ドイツパンの店 リンデ',
        //'9. ',
        '10. もくもくベーカリー',
        '11. 川越ベーカリー楽楽', 
        '12. BAKE STORE',
        '13. ガミカリー×チョップロール',
        '14. boulangerie coron',
        '15. MOGMOG BREAD', 
        '16. MANHATTAN Bakery & Wine bar',
        '17. KIYOKA MORIMOTO',
        '18. San jū san',
        '19. GOPAN-GINZA-', 
        '20. Form to Me',
        '21. フリッツァ専門店　セモア！',
        '22. Guruatsu / Toiro',
        '23. BAKER\'S PLACE',
        '24. ロータスバゲット', 
        '25. ベーカリー三日月',
        '26. CUBE THE BAKERY',
        '27. 高久製パン',
        '28. 塩パン専門店　しおき',
        '29. COUP DE COEUR', 
        '30. salut!!',
        '31. ドミニクドゥーセ　の店', 
        '32. ぱんや照光', 
        '33. ベストブレッドコンテスト', 
        '34. セレクトパンbyJPCA',
        '35. セレクトパンbyJPCA',
        '36. セレクトパンbyJPCA',
        '37. GREEN THUMB',
        '38. boulangerieECLIN',
        '39. ブレッドパーク所沢',
        '40. 自然素材の米粉パン・スイーツ専門店 IYOTO',
        '41. Cocorire',
        '42. ブーランジェリー丘の上のシェリー', 
        '43. 東京べーぐる　べーぐり',
        '44. BoulangerieLafi',
        '45. 淡路島サンハート', 
        '46. ブーランジェリー コヴィヴィアリテ',
        '47. 米粉パン CUBREAD',
        '48. 本郷ベーカリー', 
        '49. 麴自然発酵ぱん　Lemon', 
        '50. MONICA', 
        '51. パンキチ', 
        '52. ブーランジェリージョー', 
        '53. ホルンベーカリー', 
        '54. マルヤマベーカリーshian BY BUZZCAFE', 
        '55. 製パン麦玄', 
        '56. 白もくパン', 
        '57. アオハタ株式会社', // 協賛
        '58. 生活協同組合パルシステム東京', // 協賛
        '59. 日清製粉グループ', // 協賛
        '60. patopatton\'s bakery',
        '61. BEYOND SWEETS',
        '62. Fujiyama Pepper',
        '63. SANCHAI PEANUT BUTTER',
        '64. OCT.14', 
        '65. kotokoto bakery',
        '66. PLAIN COMPANY',
        '67. 241_24frames per second', 
        '68. しあわ世のもりあわせ',
        '69. H TOKYO', 
        '70. Anne‘s kitchen',
        '71. にゃーてぃすと→(studio maruto)',
        '72. 雅結寿', 
        '73. MITSUI NATURAL GARDEN',
        '74. エキストラバージンオリーブオイル ICONO',
        '75. だんだん炉の食卓', 
        '76. メローサーフ養蜂園',
        '77. 創作ジャム専門店salz',
        '78. Queue de Cochon（世田谷みやげ）',
        '79. BROOKLYN RIBBON FRIES',
        '80. 世田谷パン祭り公式グッズ',
        '81. フードドライブ', 
        '82. 三菱自動車工業株式会社', // 協賛
        '83. Tokyo Coffee Lab.',
        '84. HIGUMA Doughnuts',
        '85. 後藤醸造',
        '86. TUTU', 
        '87. CHI-FO 台湾屋台縁食区',
        '88. natoha',
        '89. THE ROAST BEEF',
        '90. Brewstars Yacht Club', 
        '91. カフェ　ヤスクーカ',
        '92. 33vin',
        '93. MAISON FARMER',
        //'94. ', 
        '95. インド料理スパイスマジック',
        '96. 池尻大橋 オカダガーリック',
        '97. NOZY COFFEE', 
        //'98. ',
        '99. ACROSS THE RIVER',
        '100. シーブリーズ',
        '101. Sun2Diner', 
        '102. WSCHOLE COFFEE ROASTER',
        '103. cotta',
        '104. あずまや　祐天寺店',
        '105. しとらす', 
        '106. 三宿おにぎり AZUMAYA',
        '107. 川津工務店',
        '108. 百年珈琲',
        '109. Volkswagen東京世田谷',//協賛
        
        // Day 1 (11/1 Sat.) のパン大学
        '110. 世田谷パン大学当日受付ブース',
        '111. 可愛いパンスタンプで世界にひとつだけのハンカチを作ろう',
        '112. 紙漉きでつくる『パンカード』',
        '113. 素焼き調粘土で『クロワッサン・ハニワ』づくり',
        '114. 【自分だけのパンをつくろう】どうぶつパン張り子 絵付けワークショップ',
        '115. 【顔はめ仮顔館】好きなパンに顔をはめよう！',
        '116. おいしいサンドイッチを作るカードゲーム「ミセスサンドイッチ」であそぼう！',
        '117. 【お子さんも参加OK】トースターで焼くパン柄プラ板キーホルダー作り',
        '118. ソルトコーディネーター青山志穂さんに学ぶ～究極の塩バタートースト～',
        '119. 風船無料配布 (先着1000名)',
        '120. 好きな木を選んで作るオリジナルバターナイフ',
        '121. -', 
        
        // Day 1 の協賛
        '122. ソフトバンク成城学園前',
        //その他
        'ご当地パン',
        '予約パン受け取り',
        'パンの図書館',
        'HWV広場',
        'HWV校門前駐輪場',
        'HWV広場横駐輪場',
        'パンマーケット待機列',
        'コンテスト投票所',
        '世田谷パンラジオ',
        'インフォメーション',
        'サーキュラーステーション',
        '休憩スペース(さくら)',
        '休憩スペース(かえで)',
        '特設ステージ',
        'いちょうトイレ',
        'さくらトイレ',
        'ミニSL',
        '平和資料館',
        '公園管理事務所',
        'バイク駐輪所',
        'いちょうトイレ横駐輪場',
        '洋弓場横駐輪場'
    ],
    'day2': [
        '1. BAKERY HOTOTOGISU',
        '2. boulangerie onni',
        '3. earth7716factory ',
        '4. ESPLAN ',
        '5. LAW',
        '6. m.3546 BAKERS', 
        '7. onkä',
        '8. PALM',
        '9. Pâtisserie dingo',
        '10. pinatis',
        '11. TSUCURITE', 
        '12. BAKE STORE',
        '13. ガミカリー×チョップロール',
        '14. boulangerie coron',
        '15. MOGMOG BREAD', 
        '16. MANHATTAN Bakery & Wine bar',
        '17. KIYOKA MORIMOTO',
        '18. San jū san',
        '19. GOPAN-GINZA-', 
        '20. Form to Me',
        '21. フリッツァ専門店　セモア！',
        '22. Guruatsu / Toiro',
        '23. BAKER\'S PLACE',
        '24. ロータスバゲット', 
        '25. ベーカリー三日月',
        '26. CUBE THE BAKERY',
        '27. 高久製パン',
        '28. 塩パン専門店　しおき',
        '29. COUP DE COEUR', 
        '30. salut!!',
        '31. ドミニクドゥーセ　の店', 
        '32. ぱんや照光', 
        '33. ベストブレッドコンテスト', 
        '34. セレクトパンbyJPCA',
        '35. セレクトパンbyJPCA',
        '36. セレクトパンbyJPCA',
        '37. GREEN THUMB',
        '38. boulangerieECLIN',
        '39. ブレッドパーク所沢',
        '40. 自然素材の米粉パン・スイーツ専門店 IYOTO',
        '41. Cocorire',
        '42. ブーランジェリー丘の上のシェリー', 
        '43. 東京べーぐる　べーぐり',
        '44. BoulangerieLafi',
        '45. 淡路島サンハート', 
        '46. ブーランジェリー コヴィヴィアリテ',
        '47. 米粉パン CUBREAD',
        '48. 本郷ベーカリー', 
        '49. 麴自然発酵ぱん　Lemon', 
        '50. MONICA', 
        // 50-56はデータなし
        '57. アオハタ株式会社', // 協賛
        '58. 生活協同組合パルシステム東京', // 協賛
        '59. 日清製粉グループ', // 協賛
        '60. FlowerBakary ハルノカオリ',
        '61. aKcompany',
        '62. Dressing Sisters', 
        '63. Hot Sauce Bar',
        '64. 自然のはちみつ屋さん La-La-Be',
        '65. Sauce  Mania', 
        '66. アーモンドツリーシェイカー',
        '67. 241_24frames per second',
        '68. しあわ世のもりあわせ',
        '69. H TOKYO', 
        '70. ル・ジャルダン・ゴロワ',
        '71. にゃーてぃすと→(studio maruto)',
        '72. 雅結寿', 
        '73. キルギスの白い生はちみつ　ジェベックジョル',
        '74. こぐぱん',
        '75. LOCALSPOON ', 
        '76. はちべえ養蜂場',
        '77. フランスくるみの店 BAOBAB TRADE',
        '78. 銭場商店',
        '79. 世田谷ファームランド',
        '80. 世田谷パン祭り公式グッズ',
        '81. フードドライブ', 
        '82. 三菱自動車工業株式会社', // 協賛
        '83. Tokyo Coffee Lab.',
        '84. HIGUMA Doughnuts',
        '85. 仁井田本家',
        '86. TUTU', 
        '87. CHI-FO 台湾屋台縁食区',
        '88. Better life with upcycle',
        '89. THE ROAST BEEF',
        '90. FARCRY BREWING', 
        '91. 有機紅茶M DASANAYAKA',
        '92. 33vin',
        '93. MAISON FARMER',
        '94. リンゴリらっぱ醸造所', 
        '95. インド料理スパイスマジック',
        '96. 池尻大橋 オカダガーリック',
        //'97. ', 
        '98. モリタンゴため息coffee',
        '99. ACROSS THE RIVER',
        '100. シーブリーズ',
        '101. Sun2Diner', 
        '102. WSCHOLE COFFEE ROASTER',
        '103. cotta',
        '104. あずまや　祐天寺店',
        '105. しとらす', 
        '106. 三宿おにぎり AZUMAYA',
        '107. 川津工務店',
        '108. 百年珈琲',
        '109. Volkswagen東京世田谷',//協賛
        
        // Day 2 (11/2 Sun.) のパン大学
        '110. 世田谷パン大学当日受付ブース',
        '111. 可愛いパンスタンプで世界にひとつだけのハンカチを作ろう',
        '112. 紙漉きでつくる『パンカード』',
        '113. 素焼き調粘土で『クロワッサン・ハニワ』づくり',
        '114. 【自分だけのパンをつくろう】どうぶつパン張り子 絵付けワークショップ',
        '115. 【顔はめ仮顔館】好きなパンに顔をはめよう！',
        '116. おいしいサンドイッチを作るカードゲーム「ミセスサンドイッチ」であそぼう！',
        '117. 笑顔の魔法 ボリパン® でパン作り', // 💡 ここに二重引用符があり、HTMLエラーの原因
        '118. ぱんとぉばしなしの会 限定復活 ～ B2D 木村達雄介シェフと味わうパンの時間～',
        '119. 風船無料配布 (先着1000名)',
        '120. 好きな木を選んで作るオリジナルバターナイフ',
        '121. パン柄デザインをシルクスクリーン印刷でいろいろなものに刷りこんでみよう！',
        
        // Day 2 の協賛
        '122. ソフトバンク成城学園前', // 122.
        //その他
        'ご当地パン',
        '予約パン受け取り',
        'パンの図書館',
        'HWV広場',
        'HWV校門前駐輪場',
        'HWV広場横駐輪場',
        'パンマーケット待機列',
        'コンテスト投票所',
        '世田谷パンラジオ',
        'インフォメーション',
        'サーキュラーステーション',
        '休憩スペース(さくら)',
        '休憩スペース(かえで)',
        '特設ステージ',
        'いちょうトイレ',
        'さくらトイレ',
        'ミニSL',
        '平和資料館',
        '公園管理事務所',
        'バイク駐輪所',
        'いちょうトイレ横駐輪場',
        '洋弓場横駐輪場'
    ]
};
        

        function generateVendorOptionsGrouped(dayStr) {
            const list = VENDOR_LIST[`day${dayStr}`] || [];
            let html = '';
            
            const groups = {
                'パン・マーケット': [],
                'パンのおとも': [],
                'グッズ/フードドライブ': [],
                'ドリンク＆フード': [],
                'HWVとパン大学': [],
                '協賛': [],
                'その他': []
            };
            
            list.forEach(fullName => {
                const match = fullName.match(/^(\d+)\./);
                const num = match ? parseInt(match[1]) : null;
                
                let category = 'その他';
                
                // GASの分類ロジック
                if (num >= 1 && num <= 56) {
                    category = 'パン・マーケット';
                } else if (num >= 60 && num <= 79) {
                    category = 'パンのおとも';
                } else if (num >= 80 && num <= 81) {
                    category = 'グッズ/フードドライブ';
                } else if (num >= 83 && num <= 108) {
                    category = 'ドリンク＆フード';
                } else if (num >= 110 && num <= 121) { // HWVとパン大学の範囲を明確に定義 (122を除く)
                    category = 'HWVとパン大学';
                }
                // 個別番号と「協賛」を含むものをチェック (HWVとパン大学と重複する番号を削除)
                else if ([57, 58, 59, 82, 109,122].includes(num) || fullName.includes('協賛')) { // 109, 110, 111を削除し、122を追加
                    category = '協賛';
                }
                
                // 存在しないカテゴリへの追加を防ぐ
                if (groups[category]) {
                    groups[category].push(fullName);
                } else {
                    groups['その他'].push(fullName);
                }
            });
            
            // HTMLの生成
            for (const [label, items] of Object.entries(groups)) {
                if (items.length > 0) {
                    html += `<optgroup label="--- ${label} ---">`;
                    items.forEach(fullName => {
                        // 純粋な店舗名を取得 (value属性用)
                        let pureName = fullName
                            .replace(/^\d+\.\s*/, '')
                            .replace(/\s\(両日\)$/, '')
                            .replace(/ by 日本パンデコレーター協会/, '')
                            .trim();
                            
                        // fullNameはドロップダウンに表示するテキスト
                        html += `<option value="${pureName}">${fullName}</option>`;
                    });
                    html += `</optgroup>`;
                }
            }

            return html;
        }

        async function recordReport(formData) {
            if (!db) {
                console.error("Firestoreが初期化されていません。");
                throw new Error("Firestoreが利用できません。");
            }

            // 報告種別に基づいてplace/contentを決定
            let placeText = formData.place; 
            let contentText = formData.content;

            // 報告ログの形式を定義
            const reportData = {
                // 報告ログであることを示す固定のtype
                type: formData.report_type, 
                
                // 場内人数集計で誤ってカウントされないようにcountは省略 (もし必要なら0を設定)
                count: 0, 

                // フォームからの報告はすべて同じevent_dayに紐づける (day1/day2)
                event_day: `day${formData.event_day_selector}`, 
                
                // 発生時刻 (手動入力があればそれを、なければサーバータイムスタンプ)
                timestamp: formData.timestamp ? new Date(formData.timestamp) : serverTimestamp(), 

                // 新規フィールド
                content: contentText,     // 報告内容（textarea）
                place: placeText,         // 発生場所/対象（ラジオボタンの値）
                reporter: formData.reporter.trim() || '匿名', // 報告者名（text input）
                vendor_name: formData.place || '', // 出店者名 (select)

                // 認証済みのユーザーID
                user_id: userId,
            };

            // GASのロジックに近くなるように type（報告種別）を content に追加
            // 例: content: "[出店者] - 内容..." のように整形する
            reportData.content = `[${formData.report_type}] ${reportData.content}`;


            // データ追加処理
            const docRef = await addDoc(getLogCollectionRef(db), reportData);
            
            console.log("報告ログが記録されました。Document ID:", docRef.id);
            return {
                status: `報告「${formData.report_type}」を記録しました！`,
                type: formData.report_type
            };
        }

        function updateVendorList() {
            // vendorSelect がまだ DOM に存在しないか、参照できていない場合は処理を中断
            if (!vendorSelect) return; 

            const selectedDayEl = document.querySelector('input[name="event_day_selector"]:checked');
            const selectedTypeEl = document.querySelector('input[name="report_type"]:checked');
            const statusEl = document.getElementById('status'); // status要素を再度取得

            if (!selectedDayEl) {
                vendorSelect.innerHTML = '<option value="">- 対象日を選択してください -</option>';
                vendorSelect.disabled = true;
                return;
            }
            
            const selectedDay = selectedDayEl.value;
            const selectedType = selectedTypeEl ? selectedTypeEl.value : null;

            if (!selectedType) {
                vendorSelect.innerHTML = '<option value="">- 報告種別を選択してください -</option>';
                vendorSelect.disabled = true;
                return;
            }
            
            vendorSelect.disabled = true;
            if (statusEl) statusEl.innerText = `リスト (Day ${selectedDay} / ${selectedType}) を読み込み中...`;
            
            try {
                // クライアント側でHTMLを生成
                // 💡 修正 4: generateVendorOptionsGrouped に selectedDay のみ渡す
                const optionsHtml = generateVendorOptionsGrouped(selectedDay); 
                
                // 💡 修正: 初期オプションのテキストを動的に変更
                const initialOptionText = (selectedType === '出店者') 
                    ? '- 出店者を選択してください (任意) -' 
                    : '- 場所を選択してください (任意) -';
                    
                vendorSelect.innerHTML = `<option value="">${initialOptionText}</option>` + optionsHtml;
                vendorSelect.disabled = false;
                if (statusEl) statusEl.innerText = 'リスト更新完了。';

            } catch(error) {
                if (statusEl) statusEl.innerText = 'エラー: リストの読み込みに失敗しました。';
                console.error("出店者リスト生成エラー:", error);
                vendorSelect.disabled = false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 💡 修正 2: Firebase初期化を実行し、結果を待つ
            const isFirebaseReady = await initializeAppAndAuth(); 
            if (!isFirebaseReady) {
                document.getElementById('status').innerText = '初期化エラー: サービスを利用できません。';
            }

            const form = document.getElementById('reportForm');
            const statusEl = document.getElementById('status');
            const recordBtn = document.getElementById('record-btn');
            
            // 💡 修正 1: vendorSelect の定義を DOMContentLoaded の中で実行し、モジュールスコープ変数に格納
            const daySelectors = document.querySelectorAll('input[name="event_day_selector"]');
            const reportTypeSelectors = document.querySelectorAll('input[name="report_type"]'); // 報告種別のラジオボタン
            vendorSelect = document.getElementById('place'); // モジュールスコープの vendorSelect に代入

            // 1. 初期時刻設定 (initializeAppAndAuth 内に移動)

            // 2. 初期イベント日設定
            const initialEventDay = '1'; 
            // 💡 修正 6: 報告種別も初期選択する。これがないと、updateVendorList の selectedTypeEl が null になる。
            document.getElementById('daySelector' + initialEventDay).checked = true;
            document.getElementById('vendor').checked = true; // 例として「出店者」をデフォルト選択
            
            // 3. リストの初期ロード (vendorSelect が定義された後に実行)
            updateVendorList();

            // 4. 対象日および報告種別選択時のイベントリスナー
            
            // 対象日 (1日目/2日目) 選択時
            daySelectors.forEach(radio => {
                radio.addEventListener('change', updateVendorList);
            });
            
            // 報告種別 (出店者/来場者/その他) 選択時
            reportTypeSelectors.forEach(radio => {
                radio.addEventListener('change', updateVendorList);
            });
            
            // 5. フォーム送信ロジック
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const typeEl = document.querySelector('input[name="report_type"]:checked');
                const dayEl = document.querySelector('input[name="event_day_selector"]:checked');
                
                if (!typeEl || !dayEl) {
                    showMessage('エラー: 報告種別と対象日を選択してください。', 'error');
                    return;
                }

                // フォームデータの取得
                const formData = {
                    report_type: typeEl.value,
                    event_day_selector: dayEl.value,
                    content: document.getElementById('content').value.trim(), 
                    // 💡 修正: vendorSelect (select要素) の値を取得
                    place: vendorSelect.value, 
                    reporter: document.getElementById('reporter').value.trim(), 
                    timestamp: document.getElementById('timestamp').value 
                };

                if (!formData.content) {
                    showMessage('エラー: 内容は必須です。', 'error');
                    return;
                }
                
                // ボタンを無効化してフィードバック
                recordBtn.disabled = true;
                showMessage('送信中...', 'info');

                try {
                    const result = await recordReport(formData);
                    showMessage(`✅ ${result.status}`, 'success');
                    
                    // フォームをリセットし、時刻とリストを再設定
                    form.reset();
                    
                    // 💡 修正 3: 時刻と初期選択を再設定
                    updateCurrentDateTime();
                    document.getElementById('daySelector' + initialEventDay).checked = true;
                    document.getElementById('vendor').checked = true;
                    updateVendorList(); 
                    
                } catch (error) {
                    console.error("Firestoreへの記録エラー:", error);
                    showMessage('致命的なエラー: 記録に失敗しました。', 'error');
                } finally {
                    recordBtn.disabled = false;
                }
            });

            /** ステータスメッセージを表示するヘルパー関数 */
            function showMessage(message, type) {
                statusEl.innerText = message;
                statusEl.className = 'mt-3 text-center text-sm font-semibold p-2 rounded-lg';
                if (type === 'success') {
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                } else {
                    statusEl.classList.add('bg-blue-100', 'text-blue-800');
                }
            }
        });

    </script>
</head>
<body class="bg-gray-100 min-h-screen pt-4 pb-16 font-sans">

    <div class="max-w-xl mx-auto px-4">
        <h1 class="text-3xl font-extrabold text-red-600 text-center mb-4 pb-2 rounded-lg">
            トラブル等記録フォーム
        </h1>
        
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <form id="reportForm">
                
                <!-- 報告種別 -->
                <div class="mb-6">
                    <label class="block text-xl font-bold text-gray-700 mb-2">報告種別 (必須):</label>
                    <div class="flex flex-wrap justify-between gap-3">
                        <label class="flex items-center text-lg cursor-pointer bg-red-50 hover:bg-red-100 p-3 rounded-xl flex-grow justify-center sm:flex-grow-0 transition duration-150 ease-in-out">
                            <input type="radio" id="vendor" name="report_type" value="出店者" class="form-radio h-5 w-5 text-red-600 mr-2" required>
                            <span class="font-medium">出店者</span>
                        </label>
                        <label class="flex items-center text-lg cursor-pointer bg-red-50 hover:bg-red-100 p-3 rounded-xl flex-grow justify-center sm:flex-grow-0 transition duration-150 ease-in-out">
                            <input type="radio" id="visitor" name="report_type" value="来場者" class="form-radio h-5 w-5 text-red-600 mr-2">
                            <span class="font-medium">来場者</span>
                        </label>
                        <label class="flex items-center text-lg cursor-pointer bg-red-50 hover:bg-red-100 p-3 rounded-xl flex-grow justify-center sm:flex-grow-0 transition duration-150 ease-in-out">
                            <input type="radio" id="other" name="report_type" value="その他" class="form-radio h-5 w-5 text-red-600 mr-2">
                            <span class="font-medium">その他</span>
                        </label>
                    </div>
                </div>
                
                <!-- 対象日 -->
                <div class="mb-6">
                    <label class="block text-xl font-bold text-gray-700 mb-2">対象日 (必須):</label>
                    <div class="flex gap-10">
                        <label class="flex items-center text-lg cursor-pointer">
                            <input type="radio" id="daySelector1" name="event_day_selector" value="1" class="form-radio h-5 w-5 text-red-600 mr-2" required>
                            <span class="font-medium">1日目</span>
                        </label>
                        <label class="flex items-center text-lg cursor-pointer">
                            <input type="radio" id="daySelector2" name="event_day_selector" value="2" class="form-radio h-5 w-5 text-red-600 mr-2">
                            <span class="font-medium">2日目</span>
                        </label>
                    </div>
                </div>
                
                <!-- 場所(プルダウン) -->
                <div class="mb-6">
                    <label for="place" class="block text-xl font-bold text-gray-700 mb-2">出店者や場所(なければ内容に記載):</label> 
                    <select id="place" name="place" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base">
                        <option value="">- 選択してください (任意) -</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- 報告者名 -->
                <div class="mb-6">
                    <label for="reporter" class="block text-xl font-bold text-gray-700 mb-2">報告者名 (任意):</label>
                    <input type="text" id="reporter" name="reporter" required placeholder="例: 担当者名、スタッフA" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base">
                </div>

                <!-- 内容 -->
                <div class="mb-6">
                    <label for="content" class="block text-xl font-bold text-gray-700 mb-2">内容 (必須):</label>
                    <textarea id="content" name="content" required placeholder="具体的な状況を記載してください" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base resize-y"></textarea>
                </div>
                
                <!-- 発生時刻 -->
                <div class="mb-4">
                    <label for="timestamp" class="block text-xl font-bold text-gray-700 mb-2">発生時刻 (任意):</label>
                    <input type="datetime-local" id="timestamp" name="timestamp" class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:border-red-500 focus:ring focus:ring-red-500 focus:ring-opacity-50 text-base">
                </div>
                
                <!-- ステータス表示 -->
                <div id="status" class="mt-2 text-center text-sm font-semibold p-2 rounded-lg min-h-8"></div>
                
                <!-- 記録ボタン -->
                <button type="submit" id="record-btn" class="w-full py-4 bg-red-600 text-white text-2xl font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-300 transform active:scale-95">
                    記録する
                </button>
            </form>
        </div>

        <!-- メニューへ戻るボタン (固定パス/index.htmlに戻ることを想定) -->
        <a href="index.html" class="block w-full py-3 mt-6 text-center text-lg font-semibold text-gray-600 bg-white border border-gray-300 rounded-xl shadow hover:bg-gray-100 transition duration-200">
            メニューへ戻る
        </a>
    </div>

</body>
</html>
