<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ´å†…äººæ•°æ¨ç§»ãƒ“ãƒ¥ãƒ¼ (Firebase Hosting)</title>
    <!-- Chart.js and Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import {
  getDocs,
  query,
  where,
  orderBy
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ----------------------------------------------------
        // 1. Firebaseè¨­å®šã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ----------------------------------------------------
        
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
            }
        }

        if (!firebaseConfig) {
            console.warn("ç’°å¢ƒå¤‰æ•°__firebase_configãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
            firebaseConfig = {
                apiKey: "AIzaSyAgLH9FWBCJy-X11vu0r3YS-VZC-B9M2xA",
                authDomain: "setapanmarketcounter.firebaseapp.com",
                databaseURL: "https://setapanmarketcounter-default-rtdb.firebaseio.com",
                projectId: "setapanmarketcounter",
                storageBucket: "setapanmarketcounter.firebasestorage.app",
                messagingSenderId: "546423839721",
                appId: "1:546423839721:web:70d5c12129fe6cc1594978",
                measurementId: "G-70KHJ0P1P1"
            };
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'setapanmarketcounter'; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let daySettings = { day1: null, day2: null }; 
        // ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•° (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®ãŸã‚ã«å¿…è¦)
        let logData = []; 
        let calculationInterval = null; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«

        // UIè¦ç´ 
        const currentCountValueEl = document.getElementById('current-count-value');
        const waitTimeValueEl = document.getElementById('wait-time-value');
        const day1VisitorsEl = document.getElementById('day1-visitors');
        const day2VisitorsEl = document.getElementById('day2-visitors');
        const totalVisitorsEl = document.getElementById('total-visitors');
        const eventDay1DateEl = document.getElementById('event-day1-date');
        const eventDay2DateEl = document.getElementById('event-day2-date');

        const LOG_COLLECTION_PATH = `/artifacts/${appId}/public/data/log`;
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹å®šç¾©ãƒ˜ãƒ«ãƒ‘ãƒ¼
        //const LOG_COLLECTION_PATH = (collectionName) => 
            // ãƒ‘ã‚¹å½¢å¼: /artifacts/setapanmarketcounter/public/data/{collectionName}
           // `artifacts/${appId}/public/data/${collectionName}`;

        //const getDayDocRef = (dbInstance) => 
       //     doc(dbInstance, LOG_COLLECTION_PATH('static'), 'day'); // static/day ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§

        //const getLogCollectionRef = (dbInstance) => 
           // collection(dbInstance, LOG_COLLECTION_PATH('log')); // log ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
                const getPublicCollectionPath = (collectionName) => 
            // ãƒ‘ã‚¹å½¢å¼: /artifacts/setapanmarketcounter/public/data/{collectionName}
            `/artifacts/${appId}/public/data/${collectionName}`;

        const getDayDocRef = (dbInstance) => 
            doc(dbInstance, getPublicCollectionPath('static'), 'day'); // static/day ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§

        const getLogCollectionRef = (dbInstance) => 
            collection(dbInstance, getPublicCollectionPath('log')); // log ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§
        let isAuthReady = false;

        // Firestoreã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ (Public Dataã¨ã—ã¦æ ¼ç´ã™ã‚‹ã“ã¨ã‚’æƒ³å®š)
        // ğŸš¨ æ³¨æ„: å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ã›ã¦ 'logs' ã®éƒ¨åˆ†ã¯èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
        // const LOG_COLLECTION_PATH = `artifacts/${appId}/public/data/log`; 

        let isInitialized = false;

        // Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼
        async function initializeFirebase() {
            if (isInitialized) return;
            isInitialized = true;
            
            try {
                // FirebaseåˆæœŸåŒ–
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // èªè¨¼
                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe();
                        if (user) {
                            console.log("Firebase: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§èªè¨¼æ¸ˆã¿");
                            userId = user.uid;
                        } else if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                                console.log("Firebase: ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§èªè¨¼æˆåŠŸ");
                            } catch (e) {
                                console.error("Firebase: ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼å¤±æ•—", e);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Firebase: åŒ¿åèªè¨¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯");
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                            console.log("Firebase: åŒ¿åèªè¨¼æˆåŠŸ");
                        }
                        isAuthReady = true;
                        resolve();
                    }, reject);
                });

                // èªè¨¼å¾Œã«ãƒ“ãƒ¥ãƒ¼ã®åˆæœŸåŒ–ã‚’é–‹å§‹
                window.externalAPI.db = db; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
                window.externalAPI.userId = userId;
                window.externalAPI.LOG_COLLECTION_PATH = LOG_COLLECTION_PATH;
                window.externalAPI.initializeViewAfterAuth(); 

            } catch (e) {
                console.error("FirebaseåˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ã‚¨ãƒ©ãƒ¼:", e);
                window.externalAPI.onFailure({ message: `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e.message}` });
            }
        }

        // --- 2. GASé–¢æ•°ã‚’ç½®ãæ›ãˆã‚‹Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * Firestoreã‹ã‚‰è¨˜éŒ²ã•ã‚ŒãŸæ—¥ä»˜ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ï¼ˆå…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ãŒå¿…è¦ãªãŸã‚éåŠ¹ç‡ã ãŒã€GASãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾ï¼‰
         * @returns {Promise<string[]>} YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜ã®é…åˆ—
         */

async function fetchRecordedDates() {
    console.log("Firestore: è¨˜éŒ²ã•ã‚ŒãŸæ—¥ä»˜ãƒªã‚¹ãƒˆã‚’å–å¾—ä¸­...");

    const dates = new Set();
    try {
        // âœ… log ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›´æ¥å‚ç…§
        const logRef = collection(db, getPublicCollectionPath("log"));
        const q = query(logRef, orderBy("timestamp", "desc")); // âœ… timestamp ã‚’ä½¿ç”¨

        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.timestamp) {
                // âœ… timestamp â†’ JS Date ã«å¤‰æ›ã—ã¦æ—¥ä»˜æ–‡å­—åˆ—ã«ã™ã‚‹
                const ts = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                const dateStr = ts.toLocaleDateString("ja-JP", { timeZone: "Asia/Tokyo" });
                dates.add(dateStr);
            }
        });

        const uniqueDates = Array.from(dates).sort().reverse();
        console.log(`Firestore: è¨˜éŒ²ã•ã‚ŒãŸæ—¥ä»˜ ${uniqueDates.length} ä»¶`);
        return uniqueDates;

    } catch (e) {
        console.error("Firestore: æ—¥ä»˜ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        throw new Error("æ—¥ä»˜ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
    }
}
        
        /**
         * ç‰¹å®šã®æ—¥ä»˜ã®å…¨ãƒ­ã‚°ã‚’å–å¾—ã—ã€å ´å†…äººæ•°ã¨å ±å‘Šä»¶æ•°ã‚’è¨ˆç®—ã™ã‚‹
         * @param {string} date YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜
         * @returns {Promise<Array<Array<any>>>} ã‚°ãƒ©ãƒ•æç”»ç”¨ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—
         */
        async function fetchDailyCountTimeline(date) {
            console.log(`Firestore: æ—¥ä»˜ **${date}** ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
            let currentCount = 0;
            const chartData = [['æ—¥æ™‚', 'å ´å†…äººæ•°', 'å ±å‘Šä»¶æ•°', 'å ±å‘Šå†…å®¹']];
            
            try {
                // dateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’timestampé †ã«å–å¾—
                const q = query(
                    collection(db, LOG_COLLECTION_PATH),
                    where("date", "==", date),
                    orderBy("timestamp", "asc")
                );

                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    console.log(`Firestore: **${date}** ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                    return chartData;
                }

                querySnapshot.forEach((doc) => {
                    const row = doc.data();
                    
                    // Firestore Timestampã‚’JavaScript Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                    const timestampDate = row.timestamp ? row.timestamp.toDate() : new Date();
                    
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ 'YYYY/MM/DD HH:mm:ss' å½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›
                    const formattedTimestamp = timestampDate.toLocaleDateString('ja-JP', {
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit', 
                        hour12: false
                    }).replace(/\//g, '/').replace(/ /g, ' ').replace(',', '');
                    
                    // --- å…¥é€€å ´è¨ˆç®— ---
                    const entryCount = row.entry || 0;
                    const exitCount = row.exit || 0;
                    currentCount += (entryCount - exitCount);
                    currentCount = Math.max(0, currentCount); // äººæ•°ã¯0æœªæº€ã«ãªã‚‰ãªã„

                    const isCounted = (entryCount > 0 || exitCount > 0);
                    
                    // --- å ±å‘Šå†…å®¹é›†ç´„ ---
                    const vendorDetails = row.vendorDetails || '';
                    const visitorDetails = row.visitorDetails || '';
                    const otherDetails = row.otherDetails || '';
                    
                    let complaintDetails = '';
                    if (vendorDetails) complaintDetails += `[å‡ºåº—è€…] ${vendorDetails}\n`;
                    if (visitorDetails) complaintDetails += `[æ¥å ´è€…] ${visitorDetails}\n`;
                    if (otherDetails) complaintDetails += `[ãã®ä»–] ${otherDetails}\n`;
                    
                    complaintDetails = complaintDetails.trim() || null; 
async function fetchDailyCountTimeline(date) {
    console.log(`Firestore: æ—¥ä»˜ **${date}** ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
    let currentCount = 0;
    const chartData = [['æ—¥æ™‚', 'å ´å†…äººæ•°', 'å ±å‘Šä»¶æ•°', 'å ±å‘Šå†…å®¹']];
    
    try {
        // ğŸ”¹ æŒ‡å®šæ—¥ã®00:00ã€œ23:59ã¾ã§ã‚’æ—¥æœ¬æ™‚é–“ã§å–å¾—
        const start = new Date(`${date}T00:00:00+09:00`);
        const end = new Date(`${date}T23:59:59+09:00`);

        const q = query(
            collection(db, LOG_COLLECTION_PATH),
            where("timestamp", ">=", start),
            where("timestamp", "<=", end),
            orderBy("timestamp", "asc")
        );

        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            console.log(`Firestore: **${date}** ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
            return chartData;
        }

        querySnapshot.forEach((doc) => {
            const row = doc.data();
            const timestampDate = row.timestamp?.toDate ? row.timestamp.toDate() : new Date(row.timestamp);

            const formattedTimestamp = timestampDate.toLocaleString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            const entryCount = row.type === "in" ? (row.count || 0) : 0;
            const exitCount = row.type === "out" ? (row.count || 0) : 0;
            currentCount += entryCount - exitCount;
            currentCount = Math.max(0, currentCount);

            // å ±å‘Šå†…å®¹
            const vendorDetails = row.vendorDetails || '';
            const visitorDetails = row.visitorDetails || '';
            const otherDetails = row.otherDetails || '';
            let complaintDetails = '';
            if (vendorDetails) complaintDetails += `[å‡ºåº—è€…] ${vendorDetails}\n`;
            if (visitorDetails) complaintDetails += `[æ¥å ´è€…] ${visitorDetails}\n`;
            if (otherDetails) complaintDetails += `[ãã®ä»–] ${otherDetails}\n`;
            complaintDetails = complaintDetails.trim() || null;
            const complaintCount = complaintDetails ? 1 : 0;

            // ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
            chartData.push([
                formattedTimestamp,
                currentCount,
                complaintCount,
                complaintDetails
            ]);
        });

        console.log(`Firestore: æŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿è¡Œæ•° (ãƒ˜ãƒƒãƒ€ãƒ¼å«ã‚€): ${chartData.length}`);
        return chartData;

    } catch (e) {
        console.error("Firestore: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        throw new Error("ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
    }
                }
        
        // --- 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªAPIã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€HTMLå´ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ ---
        window.externalAPI = {
            initializeFirebase,
            fetchRecordedDates,
            fetchDailyCountTimeline,
            db: null,
            userId: null,
            LOG_COLLECTION_PATH: null,
            // èªè¨¼å®Œäº†å¾Œã«HTMLå´ã‹ã‚‰å‘¼ã°ã‚Œã‚‹é–¢æ•° (HTMLå´ã§å®šç¾©)
            initializeViewAfterAuth: () => { /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */ },
            onFailure: () => { /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */ }
        };
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«Firebaseã®åˆæœŸåŒ–ã‚’é–‹å§‹
        window.onload = initializeFirebase;
    </script>

<style>
    /* Tailwind CSSã®æœ‰åŠ¹åŒ– */
    @layer utilities {
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #6c757d;
            height: 100%;
            text-align: center;
        }
    }
</style>
<script>
    // Tailwind CSSã®è¨­å®š
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
            },
        },
    }
</script>

</head>
<body class="bg-gray-100 font-sans p-0 m-0 min-h-screen">
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 m-4 max-w-lg w-full transform transition-transform duration-300 scale-95">
            <h3 class="text-xl font-bold mb-4 text-red-600 border-b pb-2">è¨˜éŒ²è©³ç´°</h3>
            <pre id="modal-content" class="text-gray-700 whitespace-pre-wrap text-sm leading-relaxed"></pre>
            <div class="flex justify-end mt-6">
                <button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto max-w-screen-2xl px-4 py-6">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">å ´å†…äººæ•°æ¨ç§»ãƒ“ãƒ¥ãƒ¼</h1>
            <p class="text-gray-500">Firestore ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ããƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«æ›´æ–°ã•ã‚Œã¾ã™</p>
        </header>

        <!-- ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="chart-container" class="w-full h-[75vh] min-h-[400px] bg-white rounded-xl shadow-lg mb-6 p-4">
            <canvas id="chart_div" class="loading">
                <p>Firebaseèªè¨¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </canvas>
        </div>

        <!-- è¡¨ç¤ºå˜ä½ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
            <label class="block text-lg font-semibold text-gray-700 mb-3">è¡¨ç¤ºå˜ä½:</label>
            <div class="flex flex-wrap justify-between gap-2 unit-buttons-wrapper"> 
                <button class="unit-btn flex-1 min-w-0 px-3 py-2 text-sm md:text-base border border-blue-500 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition active" data-unit="second">1ç§’</button>
                <button class="unit-btn flex-1 min-w-0 px-3 py-2 text-sm md:text-base border border-blue-500 rounded-lg text-blue-500 hover:bg-blue-50 transition" data-unit="minute">1åˆ†</button>
                <button class="unit-btn flex-1 min-w-0 px-3 py-2 text-sm md:text-base border border-blue-500 rounded-lg text-blue-500 hover:bg-blue-50 transition" data-unit="ten-minutes">10åˆ†</button>
                <button class="unit-btn flex-1 min-w-0 px-3 py-2 text-sm md:text-base border border-blue-500 rounded-lg text-blue-500 hover:bg-blue-50 transition" data-unit="thirty-minutes">30åˆ†</button>
                <button class="unit-btn flex-1 min-w-0 px-3 py-2 text-sm md:text-base border border-blue-500 rounded-lg text-blue-500 hover:bg-blue-50 transition" data-unit="hour">1æ™‚é–“</button>
            </div>
        </div>

        <!-- æ—¥ä»˜é¸æŠã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6 controls">
            <label for="dateSelector" class="block text-lg font-semibold text-gray-700 mb-3">è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ã‚’é¸æŠ:</label>
            <select id="dateSelector" class="p-3 border border-gray-300 rounded-lg w-full text-lg focus:ring-blue-500 focus:border-blue-500">
                <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JSã§è¿½åŠ ã•ã‚Œã¾ã™ -->
            </select>
            <div id="status" class="mt-4 text-gray-500 text-sm text-right"></div>
        </div>

        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ (é™çš„ãƒšãƒ¼ã‚¸ãªã®ã§ãƒªãƒ³ã‚¯ã¯ãªã—) -->
        <div class="text-center mb-8">
            <button onclick="window.history.back()" class="w-full md:w-96 bg-gray-500 text-white px-6 py-3 text-lg rounded-lg hover:bg-gray-600 transition duration-150 shadow-lg">å‰ã®ç”»é¢ã¸æˆ»ã‚‹</button>
        </div>

    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
  if (window.externalAPI) {
    window.externalAPI.initializeViewAfterAuth = initializeView;
    window.externalAPI.onFailure = onFailure;
  } else {
    const checkAPI = setInterval(() => {
      if (window.externalAPI) {
        window.externalAPI.initializeViewAfterAuth = initializeView;
        window.externalAPI.onFailure = onFailure;
        clearInterval(checkAPI);
      }
    }, 100);
  }
});
    // --- 4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    const dateSelector = document.getElementById('dateSelector');
    const statusDiv = document.getElementById('status');
    let myChart = null; 
    let rawChartData = null; 
    let currentUnit = 'second'; 
    const refreshInterval = 60000; // 60ç§’ã”ã¨ã«æ›´æ–°
    let autoRefreshTimer = null;
    
    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° (alert()ã®ä»£ã‚ã‚Š) ---
    function openModal(title, content) {
        document.getElementById('modal-content').textContent = content;
        document.querySelector('#modal h3').textContent = title;
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden', 'opacity-0');
        modal.classList.add('flex');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            document.querySelector('#modal > div').classList.remove('scale-95');
        }, 10);
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        document.querySelector('#modal > div').classList.add('scale-95');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
    
    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    document.addEventListener('DOMContentLoaded', () => {
        // å˜ä½å¤‰æ›´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.unit-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.unit-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('text-blue-500', 'hover:bg-blue-50');
                });
                this.classList.add('bg-blue-500', 'text-white');
                this.classList.remove('text-blue-500', 'hover:bg-blue-50');

                currentUnit = this.getAttribute('data-unit');
                if (rawChartData) {
                    processAndDrawChart(rawChartData);
                }
            });
        });
        
        // æ—¥ä»˜é¸æŠå¤‰æ›´ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (populateDateSelectorå†…ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
    });
    
    // // --- Firebaseèªè¨¼å®Œäº†å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹åˆæœŸåŒ–é–¢æ•° (import scriptã‹ã‚‰ã‚³ãƒ¼ãƒ«ã•ã‚Œã‚‹) ---
  //  window.externalAPI.initializeViewAfterAuth = initializeView;
   // window.externalAPI.onFailure = onFailure;


    function setupAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
        }
        // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã€60ç§’ã”ã¨ã« drawChart ã‚’å†å®Ÿè¡Œ
        autoRefreshTimer = setInterval(() => {
            const currentDate = dateSelector.value;
            console.log(`[AutoRefresh] ${currentDate} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ä¸­...`);
            drawChart(currentDate); 
        }, refreshInterval);
    }

    async function initializeView() {
        try {
            // Firebaseã‹ã‚‰æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’å–å¾—
            const dates = await window.externalAPI.fetchRecordedDates();
            populateDateSelector(dates);
        } catch (error) {
            onFailure(error);
        }
    }

    function populateDateSelector(dates) {
        if (!Array.isArray(dates) || dates.length === 0) {
            document.getElementById('chart_div').textContent = `ã‚«ã‚¦ãƒ³ãƒˆã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
            document.querySelector('.controls').classList.add('hidden');
            document.querySelector('.unit-buttons-wrapper').parentNode.classList.add('hidden');
            return;
        }
        
        // æ—¥ä»˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ
        dateSelector.innerHTML = '';
        dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            dateSelector.appendChild(option);
        });

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°åˆæœŸé¸æŠã€ãªã‘ã‚Œã°æœ€æ–°ã®æ—¥ä»˜ã‚’é¸æŠ
        const urlParams = new URLSearchParams(window.location.search);
        const initialDate = urlParams.get('date') || dates[0];
        dateSelector.value = initialDate;
        
        // æ—¥ä»˜é¸æŠå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        dateSelector.addEventListener('change', function() {
            drawChart(dateSelector.value);
        });

        // åˆå›æç”»ã¨è‡ªå‹•æ›´æ–°ã®è¨­å®š
        drawChart(initialDate);
        setupAutoRefresh();
    }

    async function drawChart(date) {
        if (myChart) {
            myChart.destroy();
        }

        const container = document.getElementById('chart-container');
        // canvasè¦ç´ ã‚’å†ç”Ÿæˆã—ã€ãƒ­ãƒ¼ãƒ‰ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        container.innerHTML = `<canvas id="chart_div" class="loading"><p>ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p></canvas>`;

        try {
            // Firebaseã‹ã‚‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const chartData = await window.externalAPI.fetchDailyCountTimeline(date);
            onDataReceived(chartData);

        } catch (error) {
            onFailure(error);
        }
    }

    function onDataReceived(chartData) {
        rawChartData = chartData; 

        const container = document.getElementById('chart-container');

        if (!rawChartData || rawChartData.length <= 1) { 
            container.innerHTML = `<canvas id="chart_div" class="loading"><p class="text-xl font-medium text-gray-600">**${dateSelector.value}** ã«ã¯å…¥é€€å ´ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></canvas>`;
            return;
        }

        processAndDrawChart(rawChartData);
    }

    function processAndDrawChart(data) {
        const aggregated = aggregateData(data, currentUnit);

        const chartLabels = aggregated.labels;
        const attendanceData = aggregated.attendance;
        const complaintData = aggregated.complaint;
        const complaintMap = aggregated.complaintMap;

        const chartElement = document.getElementById('chart_div');
        if (!chartElement) {
            console.error(`[DOM ERROR] ID 'chart_div' ã® canvas è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
            return;
        }
        const ctx = chartElement.getContext('2d');

        if (myChart) {
            myChart.destroy();
        }
        
        try {
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'å ´å†…äººæ•°',
                            data: attendanceData,
                            yAxisID: 'y1',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.2,
                            fill: false,
                            pointRadius: (currentUnit === 'second' || currentUnit === 'minute') ? 3 : 0 
                        },
                        {
                            label: 'ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ²ä»¶æ•°',
                            data: complaintData,
                            yAxisID: 'y2',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            type: 'bar',
                            order: 1,
                            pointRadius: 0,
                            barPercentage: 0.8 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 }, 
                    onClick: (e) => {
                        const activePoints = myChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (activePoints.length > 0) {
                            const firstPoint = activePoints[0];
                            const label = chartLabels[firstPoint.index];
                            
                            if (complaintMap[label]) {
                                openModal(`ã€ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ²å†…å®¹ - ${dateSelector.value} ${label}ã€‘`, complaintMap[label]);
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${dateSelector.value} ã®å ´å†…/ãƒˆãƒ©ãƒ–ãƒ«ç­‰è¨˜éŒ²æ¨ç§» (${getUnitLabel(currentUnit)}å˜ä½)`,
                            font: { size: 18 } 
                        },
                        legend: { 
                            position: 'bottom',
                            labels: { font: { size: 14 } } 
                        },
                        tooltip: {
                            bodyFont: { size: 14 }, 
                            titleFont: { size: 14 }
                        }
                    },
                    scales: {
                        y1: { 
                            type: 'linear', position: 'left',
                            title: { display: true, text: 'å ´å†…äººæ•°', font: { size: 18 } }, 
                            beginAtZero: true,
                            ticks: { font: { size: 14 } } 
                        },
                        y2: { 
                            type: 'linear', position: 'right',
                            title: { display: true, text: 'ãƒˆãƒ©ãƒ–ãƒ«ç­‰ä»¶æ•° (é›†è¨ˆ)', font: { size: 18 } }, 
                            min: 0,
                            max: Math.ceil(Math.max(1, ...complaintData) * 1.1), 
                            grid: { drawOnChartArea: false },
                            ticks: { font: { size: 14, stepSize: 1 } } 
                        },
                        x: {
                            title: { display: true, text: 'æ™‚åˆ»', font: { size: 18 } },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 0, 
                                minRotation: 0,
                                font: { size: 14 }, 
                                callback: function(val, index) {
                                    const fullTime = this.getLabelForValue(val);
                                    // ç§’ãƒ»åˆ†å˜ä½ã§ã¯5åˆ†ã”ã¨ã«ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾
                                    if (currentUnit === 'second' || currentUnit === 'minute') {
                                        const parts = fullTime.split(':'); 
                                        const minutes = parseInt(parts[1]);
                                        if (minutes % 5 !== 0) return '';
                                    }
                                    return formatTimeLabel(fullTime, currentUnit);
                                }
                            }
                        }
                    }
                }
            });
        } catch (e) {
            console.error(`[CHART ERROR] Chart.js ã®æç”»ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, e); 
        }

        statusDiv.textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP', {hour12: false})}`;
    }

    function aggregateData(data, unit) {
        if (unit === 'second') {
            const labels = [];
            const attendance = [];
            const complaint = [];
            const complaintMap = {};
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const timePart = row[0]; // HH:mm:ss
                
                labels.push(timePart);
                attendance.push(row[1]);
                complaint.push(row[2]);
                
                if (row[2] > 0 && row[3]) {
                    // complaintMapã«ã¯HH:mm:ssã¨è©³ç´°ã‚’æ ¼ç´
                    complaintMap[timePart] = `${timePart} ${row[3]}`; 
                }
            }
            return { labels, attendance, complaint, complaintMap };
        }

        const intervalMinutes = {
            'minute': 1,
            'ten-minutes': 10,
            'thirty-minutes': 30,
            'hour': 60
        }[unit];
        
        const aggregated = {}; 

        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const timestampString = row[0]; // HH:mm:ss
            
            // æ—¥ä»˜æƒ…å ±ãŒãªã„ãŸã‚ã€ä»Šæ—¥ã®ãƒ€ãƒŸãƒ¼æ—¥ä»˜ã‚’ä½¿ã£ã¦Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            const today = new Date().toISOString().substring(0, 10); // YYYY-MM-DD
            const timestamp = new Date(`${today} ${timestampString}`);
            
            if (isNaN(timestamp.getTime())) {
                continue;
            }
            
            const attendanceCount = row[1];
            const complaintCount = row[2];
            const complaintDetails = row[3];
            
            let hour = timestamp.getHours();
            let minute = timestamp.getMinutes();
            
            // å˜ä½ã«åŸºã¥ã„ãŸåˆ†ã¸ã®åˆ‡ã‚Šæ¨ã¦
            minute = Math.floor(minute / intervalMinutes) * intervalMinutes;

            const minuteStr = String(minute).padStart(2, '0');
            const hourStr = String(hour).padStart(2, '0');
            const key = `${hourStr}:${minuteStr}`; // é›†è¨ˆã‚­ãƒ¼ HH:mm
            
            if (!aggregated[key]) {
                aggregated[key] = {
                    lastAttendance: attendanceCount, 
                    complaintSum: 0,
                    complaintDetails: [] 
                };
            } else {
                // æœ€å¾Œã®ãƒ­ã‚°ã®å ´å†…äººæ•°ã‚’æ¡ç”¨
                aggregated[key].lastAttendance = attendanceCount; 
            }

            aggregated[key].complaintSum += complaintCount;
            
            if (complaintDetails) {
                // æ™‚åˆ»æƒ…å ± (HH:mm:ss) ã¨å†…å®¹ã‚’ã‚»ãƒƒãƒˆã«ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã«ãƒ—ãƒƒã‚·ãƒ¥
                aggregated[key].complaintDetails.push({
                    time: timestampString, // HH:mm:ss
                    detail: complaintDetails
                });
            }
        }

        const labels = [];
        const attendance = [];
        const complaint = [];
        const complaintMap = {};

        // é›†è¨ˆã‚­ãƒ¼ã§ã‚½ãƒ¼ãƒˆã—ã¦æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        Object.keys(aggregated).sort().forEach(key => {
            const item = aggregated[key];
            labels.push(key);
            attendance.push(item.lastAttendance);
            complaint.push(item.complaintSum);
            
            if (item.complaintDetails.length > 0) {
                // é›†è¨ˆå˜ä½ã®æ™‚åˆ» (HH:mm) ã«ç´ã¥ãå…¨ã¦ã®ãƒˆãƒ©ãƒ–ãƒ«è©³ç´°ã‚’çµåˆ
                complaintMap[key] = item.complaintDetails.map(record => {
                    return `(${record.time}) ${record.detail}`; 
                }).join('\n----------\n'); 
            }
        });
        
        return { labels, attendance, complaint, complaintMap };
    }

    function getUnitLabel(unit) {
        return {
            'second': '1ç§’',
            'minute': '1åˆ†',
            'ten-minutes': '10åˆ†',
            'thirty-minutes': '30åˆ†',
            'hour': '1æ™‚é–“'
        }[unit];
    }

    function formatTimeLabel(timeString, unit) {
        // timeStringã¯ 'HH:mm:ss' ã¾ãŸã¯ 'HH:mm' ã®å½¢å¼ã‚’æƒ³å®š
        const parts = timeString.split(':');

        const h = parts[0]; // æ™‚
        const m = parts[1]; // åˆ†
        const s = parts[2]; // ç§’ 

        if (unit === 'second') {
            // 1ç§’å˜ä½: æ™‚\nåˆ†\nç§’
            return [h, m, s];
        } else if (unit === 'minute') {
            // 1åˆ†å˜ä½: æ™‚\nåˆ†
            return [h, m];
        } else {
            // 10åˆ†ã€30åˆ†ã€1æ™‚é–“å˜ä½: æ™‚ã®ã¿ã€ã¾ãŸã¯æ™‚:åˆ†
            return (parts.length > 1 && m !== '00') ? [h, m] : [h];
        }
    }
    
    function onFailure(error) {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
        }
        statusDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`;
        console.error(`[FATAL ERROR] ãƒ‡ãƒ¼ã‚¿å–å¾—ã¾ãŸã¯Firebaseå‡¦ç†å¤±æ•—:`, error);
        if (myChart) myChart.destroy();
        const container = document.getElementById('chart-container');
        container.innerHTML = `<canvas id="chart_div" class="loading"><p class="text-xl font-medium text-red-500">ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p><p class="text-sm text-gray-500 mt-2">${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</p></canvas>`;
    }
</script>
</body>
</html>
